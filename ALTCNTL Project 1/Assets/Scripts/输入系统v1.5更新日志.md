# 输入系统 v1.5.0 更新日志

## 📅 更新日期
2024-10-15

---

## 🎯 主要更新

### 1. 小键盘输入 🎹
- 将所有输入按键从数字键（Alpha1-4）改为小键盘（Keypad1-4）
- 更符合游戏手柄/街机操作习惯
- 与主键盘数字键分离，避免冲突

### 2. 长按重复触发 ⏱️
- 按住按键1秒后自动再次触发
- 可以实现连续快速操作
- 可在Inspector中调整触发时间
- 可以完全禁用长按功能

### 3. 倾倒阶段跨越 ⚡
- 在左倾倒时按小键盘4 → 跨越4个阶段到右倾1
- 在右倾倒时按小键盘1 → 跨越4个阶段到左倾1
- 提供快速救援机制
- 增加游戏的策略性和可玩性

---

## 🔄 版本对比

### v1.4.0 → v1.5.0

| 特性 | v1.4.0 | v1.5.0 |
|------|--------|--------|
| 按键类型 | 数字键 (Alpha1-4) | 小键盘 (Keypad1-4) |
| 长按功能 | ❌ 无 | ✅ 1秒后重复触发 |
| 倾倒跨越 | ❌ 无 | ✅ 跨越4个阶段 |
| 倾倒回退 | ✅ 回到Tilt2 | ✅ 保留（回到Tilt2） |
| 输入代码 | `GetKeyDown` 单次检测 | `GetKey` 持续检测 + 计时 |

---

## 📋 详细变更

### 代码层面

#### SwayController.cs

**新增字段：**
```csharp
[Header("长按设置")]
public float holdDuration = 1.0f;
public bool enableHoldRepeat = true;

// 长按检测变量
private float leftToppleHoldTime = 0f;
private float tiltLeftHoldTime = 0f;
private float tiltRightHoldTime = 0f;
private float rightToppleHoldTime = 0f;
private bool leftToppleHoldTriggered = false;
private bool tiltLeftHoldTriggered = false;
private bool tiltRightHoldTriggered = false;
private bool rightToppleHoldTriggered = false;
```

**新增方法：**
```csharp
void HandleKeyInput(KeyCode key, ref float holdTime, ref bool holdTriggered, System.Action action)
void HandleLeftToppleInput()
void HandleRightToppleInput()
void JumpPhases(int steps)
```

**修改方法：**
```csharp
void HandlePlayerInput() // 完全重写，使用新的输入检测机制
```

#### SwaySystemQuickSetup.cs

**更新配置：**
```csharp
controller.instantLeftToppleKey = KeyCode.Keypad1;  // Alpha1 → Keypad1
controller.tiltLeftKey = KeyCode.Keypad2;           // Alpha2 → Keypad2
controller.tiltRightKey = KeyCode.Keypad3;          // Alpha3 → Keypad3
controller.instantRightToppleKey = KeyCode.Keypad4; // Alpha4 → Keypad4

// 新增
controller.holdDuration = 1.0f;
controller.enableHoldRepeat = true;
```

---

## 🎮 行为变化

### 场景1：居中阶段按小键盘1

**v1.4.0：**
```
按下 Alpha1 → 立即左倾倒 → 掉落1个物品
松开 Alpha1 → 无反应
```

**v1.5.0：**
```
按下 Keypad1 → 立即左倾倒 → 掉落1个物品
持续按住 → 1秒后 → 再次掉落1个物品
松开 Keypad1 → 计时重置
```

### 场景2：左倾倒阶段按小键盘4

**v1.4.0：**
```
按下 Alpha4 → 无效（已在倾倒状态，不能再倾倒）
```

**v1.5.0：**
```
按下 Keypad4 → 跨越4个阶段 → 到达右倾1
               左倾倒(-3) → ... → 右倾1(1)
```

### 场景3：居中阶段长按小键盘2

**v1.4.0：**
```
按下 Alpha2 → 居中 → 左倾1
持续按住 → 无反应
```

**v1.5.0：**
```
按下 Keypad2 → 居中 → 左倾1
持续按住 → 1秒后 → 左倾1 → 左倾2
松开 → 计时重置
```

---

## 🔧 配置参数

### 新增参数

| 参数名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `holdDuration` | float | 1.0秒 | 长按触发时间 |
| `enableHoldRepeat` | bool | true | 是否启用长按重复触发 |

### 修改参数

| 参数名 | v1.4.0 | v1.5.0 |
|--------|--------|--------|
| `instantLeftToppleKey` | Alpha1 | Keypad1 |
| `tiltLeftKey` | Alpha2 | Keypad2 |
| `tiltRightKey` | Alpha3 | Keypad3 |
| `instantRightToppleKey` | Alpha4 | Keypad4 |

---

## ⚙️ 游戏平衡影响

### 难度调整建议

**简单模式：**
- `holdDuration = 0.8秒` - 更快的连续操作
- 倾倒跨越距离保持4个阶段

**普通模式（默认）：**
- `holdDuration = 1.0秒`
- 倾倒跨越距离4个阶段

**困难模式：**
- `holdDuration = 1.5秒` - 需要更精确的时机
- 可选：将跨越距离改为3个阶段（需修改代码）

### 策略性增强

1. **长按机制**
   - 增加了快速连续操作的可能性
   - 玩家需要在"快速按多次"和"长按等待"之间做出选择
   - 过渡期间无法操作，增加了风险

2. **跨越机制**
   - 提供了从极端状态快速恢复的能力
   - 但跨越后仍处于倾斜状态，需要继续调整
   - 增加了"以退为进"的战术选择

---

## 🐛 已知问题

### 问题1：过渡期间长按无效
**描述**：在阶段转换动画期间，即使按住按键，也不会触发
**原因**：`isTransitioning` 标志会阻止所有输入
**影响**：低
**解决方案**：设计使然，保持动画完整性

### 问题2：快速按键可能触发两次
**描述**：如果按键恰好在长按触发前松开并重新按下，可能会快速触发两次
**原因**：长按计时和按键检测的时机问题
**影响**：低
**解决方案**：当前机制可接受

---

## 🧪 测试清单

### 基础功能测试
- [x] 小键盘1-4单次按下
- [x] 小键盘1-4长按触发（1秒）
- [x] 长按时松开重置计时
- [x] 禁用长按功能后无重复触发

### 跨越功能测试
- [x] 左倾倒时按小键盘4跨越到右倾1
- [x] 右倾倒时按小键盘1跨越到左倾1
- [x] 非倾倒阶段按倾倒键正常进入倾倒

### 回退功能测试
- [x] 左倾倒时按小键盘2回到左倾2
- [x] 右倾倒时按小键盘3回到右倾2
- [x] 倾倒时按同方向键无效

### 边界测试
- [x] 跨越不会超出有效范围（-3到3）
- [x] 过渡期间所有输入被忽略
- [x] 多个按键同时按下的处理

### 性能测试
- [x] 长时间按住不会导致性能问题
- [x] 快速连续按键响应正常

---

## 📝 升级指南

### 从 v1.4.0 升级到 v1.5.0

**步骤1：更新代码**
- 确保 `SwayController.cs` 为最新版本
- 检查 `SwaySystemQuickSetup.cs` 已更新

**步骤2：更新场景**
- 选中场景中的 SwayController 对象
- 检查 Inspector 中按键配置是否为 Keypad1-4
- 如果仍为 Alpha1-4，手动修改或删除对象重新创建

**步骤3：测试**
- 运行游戏
- 使用小键盘1-4测试基础功能
- 测试长按功能
- 测试倾倒跨越功能

**步骤4：调整参数（可选）**
- 根据游戏难度调整 `Hold Duration`
- 决定是否启用 `Enable Hold Repeat`

---

## 🔗 相关文档

- **详细说明**：`长按输入系统说明.md`
- **快速参考**：`小键盘输入快速参考.txt`
- **系统总览**：`README_SWAY_SYSTEM.md`
- **回退功能**：`倾倒阶段回退功能说明.md`

---

## 💬 开发者备注

### 设计思路

1. **为什么选择小键盘？**
   - 更符合街机/手柄操作习惯
   - 物理位置更集中，更容易盲操
   - 与主键盘数字键分离，避免与其他功能冲突

2. **为什么是1秒？**
   - 既不会太快导致误触
   - 也不会太慢影响操作流畅度
   - 可以根据游戏节奏调整

3. **为什么跨越4个阶段？**
   - 刚好从一个倾倒到达对面的倾1
   - 既提供了救援，又保留了危险感
   - 不会直接到中心或对面倾倒，保持游戏平衡

### 未来可能的改进

1. **连续长按**：按住不放，每1秒连续触发（当前只触发一次）
2. **可变跨越距离**：根据难度或游戏进度调整跨越距离
3. **长按反馈**：添加视觉/音效反馈，显示长按进度
4. **手柄支持**：支持Xbox/PS手柄的方向键和按钮

---

**v1.5.0 - 更灵活、更有策略性的输入系统！** 🎮

