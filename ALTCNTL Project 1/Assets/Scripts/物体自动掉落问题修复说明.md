# ç‰©ä½“è‡ªåŠ¨æ‰è½é—®é¢˜ä¿®å¤è¯´æ˜

> **é—®é¢˜**: å †å ç‰©ä½“åœ¨åˆ›å»ºæ—¶å°±å¼€å§‹æ‰è½  
> **åº”è¯¥**: ä»…åœ¨å€¾å€’ï¼ˆToppleï¼‰é˜¶æ®µæ‰æ‰è½  
> **ä¿®å¤æ—¥æœŸ**: 2025-10-13

---

## ğŸ› é—®é¢˜æè¿°

### ç°è±¡
- ç‰©ä½“åˆšåˆ›å»ºå°±å¼€å§‹ä¸‹è½
- æ— æ³•ä¿æŒåœ¨å †å ä½ç½®
- ç‰©ä½“åº”è¯¥é™æ­¢ï¼Œç›´åˆ°è¿›å…¥å€¾å€’é˜¶æ®µ

### æ ¹æœ¬åŸå› 

**å¯èƒ½çš„åŸå› ï¼š**

1. **é¢„åˆ¶ä½“åŒ…å«ç‰©ç†ç»„ä»¶**
   ```
   ç‰©ä½“é¢„åˆ¶ä½“ (objectPrefab) å¯èƒ½æœ‰ï¼š
   - Rigidbodyï¼ˆ3Dç‰©ç†ï¼‰
   - Rigidbody2Dï¼ˆ2Dç‰©ç†ï¼‰
   - è¿™äº›ç»„ä»¶ä¼šå¯¼è‡´ç‰©ä½“å—é‡åŠ›å½±å“è‡ªåŠ¨ä¸‹è½
   ```

2. **é¢„åˆ¶ä½“åŒ…å«æ‰è½åŠ¨ç”»**
   ```
   é¢„åˆ¶ä½“ä¸Šå¯èƒ½å·²ç»æœ‰ DropAnimation ç»„ä»¶
   å¯¼è‡´åˆ›å»ºæ—¶å°±å¼€å§‹æ‰§è¡Œæ‰è½åŠ¨ç”»
   ```

3. **é»˜è®¤ç«‹æ–¹ä½“æœ‰ç¢°æ’å™¨**
   ```
   GameObject.CreatePrimitive(PrimitiveType.Cube)
   è‡ªå¸¦ BoxCollider + Rigidbodyï¼ˆå¦‚æœåœºæ™¯æœ‰ç‰©ç†ï¼‰
   ```

4. **çˆ¶å¯¹è±¡è®¾ç½®é—®é¢˜**
   ```
   å¦‚æœç‰©ä½“ä¸åœ¨ StackRoot ä¸‹
   å¯èƒ½ä¸å—å †å ç³»ç»Ÿç®¡ç†
   ```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: ç§»é™¤é¢„åˆ¶ä½“ä¸Šçš„ç‰©ç†ç»„ä»¶

```csharp
if (objectPrefab != null)
{
    newObject = Instantiate(objectPrefab, stackRoot);
    
    // æ–°å¢ï¼šç§»é™¤æ‰€æœ‰ç‰©ç†ç»„ä»¶
    Rigidbody rb = newObject.GetComponent<Rigidbody>();
    if (rb != null)
    {
        Debug.Log($"[StackController] ç§»é™¤é¢„åˆ¶ä½“ä¸Šçš„ Rigidbody ç»„ä»¶");
        Destroy(rb);
    }
    
    Rigidbody2D rb2d = newObject.GetComponent<Rigidbody2D>();
    if (rb2d != null)
    {
        Debug.Log($"[StackController] ç§»é™¤é¢„åˆ¶ä½“ä¸Šçš„ Rigidbody2D ç»„ä»¶");
        Destroy(rb2d);
    }
    
    // ç§»é™¤ç¢°æ’å™¨
    Collider col = newObject.GetComponent<Collider>();
    if (col != null) Destroy(col);
    
    Collider2D col2d = newObject.GetComponent<Collider2D>();
    if (col2d != null) Destroy(col2d);
    
    // ç§»é™¤å¯èƒ½å·²å­˜åœ¨çš„æ‰è½åŠ¨ç”»ç»„ä»¶
    DropAnimation dropAnim = newObject.GetComponent<DropAnimation>();
    if (dropAnim != null)
    {
        Debug.Log($"[StackController] ç§»é™¤é¢„åˆ¶ä½“ä¸Šçš„ DropAnimation ç»„ä»¶");
        Destroy(dropAnim);
    }
}
```

### ä¿®å¤2: é»˜è®¤ç«‹æ–¹ä½“ä¹Ÿç§»é™¤ç‰©ç†ç»„ä»¶

```csharp
else // åˆ›å»ºé»˜è®¤ç«‹æ–¹ä½“
{
    newObject = GameObject.CreatePrimitive(PrimitiveType.Cube);
    newObject.transform.SetParent(stackRoot);
    
    // ç§»é™¤ç¢°æ’å™¨
    Destroy(newObject.GetComponent<Collider>());
    
    // æ–°å¢ï¼šç§»é™¤å¯èƒ½çš„ç‰©ç†ç»„ä»¶
    Rigidbody rb = newObject.GetComponent<Rigidbody>();
    if (rb != null) Destroy(rb);
    
    Rigidbody2D rb2d = newObject.GetComponent<Rigidbody2D>();
    if (rb2d != null) Destroy(rb2d);
    
    // ç§»é™¤å¯èƒ½çš„æ‰è½åŠ¨ç”»ç»„ä»¶
    DropAnimation dropAnim = newObject.GetComponent<DropAnimation>();
    if (dropAnim != null) Destroy(dropAnim);
}
```

### ä¿®å¤3: éªŒè¯çˆ¶å¯¹è±¡è®¾ç½®

```csharp
// éªŒè¯çˆ¶å¯¹è±¡è®¾ç½®æ­£ç¡®
if (newObject.transform.parent != stackRoot)
{
    Debug.LogError($"[StackController] é”™è¯¯ï¼š{newObject.name} çš„çˆ¶å¯¹è±¡ä¸æ˜¯ StackRootï¼å¼ºåˆ¶è®¾ç½®ã€‚");
    newObject.transform.SetParent(stackRoot);
    newObject.transform.localPosition = new Vector3(0, yPosition, 0);
}
```

### ä¿®å¤4: å¢å¼ºæ—¥å¿—éªŒè¯

```csharp
if (logDropEvents)
{
    Debug.Log($"[StackController] âœ“ æ·»åŠ ç‰©ä½“: {newObject.name}");
    Debug.Log($"  - çˆ¶å¯¹è±¡: {newObject.transform.parent.name}");
    Debug.Log($"  - æœ¬åœ°ä½ç½®: {newObject.transform.localPosition}");
    Debug.Log($"  - ä¸–ç•Œä½ç½®: {newObject.transform.position}");
    Debug.Log($"  - æœ‰ç‰©ç†ç»„ä»¶: Rigidbody={newObject.GetComponent<Rigidbody>() != null}, Rigidbody2D={newObject.GetComponent<Rigidbody2D>() != null}");
}
```

---

## ğŸ” éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥Consoleæ—¥å¿—

è¿è¡Œæ¸¸æˆåï¼Œåº”è¯¥çœ‹åˆ°ï¼š

**æ­£å¸¸æƒ…å†µï¼ˆæ— ç‰©ç†ç»„ä»¶ï¼‰:**
```
[StackController] âœ“ æ·»åŠ ç‰©ä½“: StackObject_0
  - çˆ¶å¯¹è±¡: StackRoot
  - æœ¬åœ°ä½ç½®: (0.00, 0.00, 0.00)
  - ä¸–ç•Œä½ç½®: (0.00, 0.00, 0.00)
  - æœ‰ç‰©ç†ç»„ä»¶: Rigidbody=False, Rigidbody2D=False  â† é‡è¦ï¼
```

**å¦‚æœé¢„åˆ¶ä½“æœ‰ç‰©ç†ç»„ä»¶:**
```
[StackController] ç§»é™¤é¢„åˆ¶ä½“ä¸Šçš„ Rigidbody ç»„ä»¶  â† è‡ªåŠ¨ç§»é™¤
[StackController] âœ“ æ·»åŠ ç‰©ä½“: StackObject_0
  - æœ‰ç‰©ç†ç»„ä»¶: Rigidbody=False, Rigidbody2D=False  â† å·²æ¸…ç†
```

### 2. è§‚å¯ŸSceneè§†å›¾

- ç‰©ä½“åº”è¯¥é™æ­¢ä¸åŠ¨
- å †å æ•´é½æ’åˆ—
- ä¸ä¼šè‡ªåŠ¨ä¸‹è½

### 3. éªŒè¯æ‰è½åªåœ¨å€¾å€’æ—¶å‘ç”Ÿ

**æµ‹è¯•æ­¥éª¤ï¼š**
1. è¿è¡Œæ¸¸æˆ
2. ç‰©ä½“åº”è¯¥é™æ­¢ï¼ˆâœ“ï¼‰
3. æŒ‰ç®­å¤´é”®å€¾æ–œåˆ°å€¾å€’é˜¶æ®µ
4. ç°åœ¨ç‰©ä½“æ‰åº”è¯¥æ‰è½ï¼ˆâœ“ï¼‰

---

## ğŸ“‹ é—®é¢˜è¯Šæ–­æ¸…å•

### å¦‚æœç‰©ä½“ä»ç„¶ä¸‹è½ï¼Œæ£€æŸ¥ï¼š

**1. é¢„åˆ¶ä½“é…ç½®**
- [ ] æ£€æŸ¥é¢„åˆ¶ä½“æ˜¯å¦æœ‰ Rigidbody
- [ ] æ£€æŸ¥é¢„åˆ¶ä½“æ˜¯å¦æœ‰ Rigidbody2D
- [ ] æ£€æŸ¥é¢„åˆ¶ä½“æ˜¯å¦æœ‰ DropAnimation
- [ ] æŸ¥çœ‹Consoleæ˜¯å¦æ˜¾ç¤º"ç§»é™¤ç»„ä»¶"æ—¥å¿—

**2. é¡¹ç›®è®¾ç½®**
- [ ] Edit â†’ Project Settings â†’ Physics
- [ ] æ£€æŸ¥ Gravity æ˜¯å¦ä¸º 0ï¼ˆå¦‚æœä¸æƒ³è¦é‡åŠ›ï¼‰
- [ ] æˆ–ç¡®ä¿ç‰©ä½“æ—  Rigidbody

**3. åœºæ™¯è®¾ç½®**
- [ ] ç¡®è®¤ SwaySystem GameObject å­˜åœ¨
- [ ] ç¡®è®¤ StackRoot å·²åˆ›å»º
- [ ] ç¡®è®¤ç‰©ä½“åœ¨ StackRoot ä¸‹

**4. å…¶ä»–è„šæœ¬**
- [ ] æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è„šæœ¬ç§»åŠ¨ç‰©ä½“
- [ ] æ£€æŸ¥æ˜¯å¦æœ‰å…¨å±€ç‰©ç†ç®¡ç†å™¨

---

## ğŸ¯ æ­£ç¡®çš„å·¥ä½œæµç¨‹

### å †å ç‰©ä½“çš„ç”Ÿå‘½å‘¨æœŸ

```
1. åˆ›å»ºé˜¶æ®µï¼ˆAddObjectToStackï¼‰
   â”œâ”€â”€ å®ä¾‹åŒ–é¢„åˆ¶ä½“/åˆ›å»ºç«‹æ–¹ä½“
   â”œâ”€â”€ ç§»é™¤æ‰€æœ‰ç‰©ç†ç»„ä»¶ â† ä¿®å¤ç‚¹ï¼
   â”œâ”€â”€ è®¾ç½®çˆ¶å¯¹è±¡ä¸º StackRoot
   â”œâ”€â”€ è®¾ç½®æœ¬åœ°ä½ç½®
   â””â”€â”€ ç‰©ä½“é™æ­¢ä¸åŠ¨ âœ“

2. å †å é˜¶æ®µï¼ˆæ­£å¸¸çŠ¶æ€ï¼‰
   â”œâ”€â”€ ç‰©ä½“åœ¨ StackRoot ä¸‹
   â”œâ”€â”€ å— SwayController æ—‹è½¬å½±å“
   â”œâ”€â”€ å— StackVisualController åç§»å½±å“
   â””â”€â”€ ç‰©ä½“ä¿æŒé™æ­¢ âœ“

3. å€¾å€’é˜¶æ®µï¼ˆOnToppleDropï¼‰
   â”œâ”€â”€ SwayController è¿›å…¥ Topple é˜¶æ®µ
   â”œâ”€â”€ è§¦å‘ OnToppleDrop äº‹ä»¶
   â”œâ”€â”€ RemoveTopObject() ç§»é™¤ç‰©ä½“
   â”œâ”€â”€ ç§»å‡º StackRoot
   â”œâ”€â”€ æ·»åŠ  DropAnimation ç»„ä»¶ â† ä»…æ­¤æ—¶æ·»åŠ ï¼
   â””â”€â”€ ç‰©ä½“å¼€å§‹æ‰è½ âœ“
```

---

## ğŸ› ï¸ é¢„åˆ¶ä½“æœ€ä½³å®è·µ

### åˆ›å»ºå †å ç‰©ä½“é¢„åˆ¶ä½“

**æ¨èé…ç½®ï¼š**
```
StackObjectPrefab
â”œâ”€â”€ SpriteRendererï¼ˆ2Dï¼‰æˆ– MeshRendererï¼ˆ3Dï¼‰
â”œâ”€â”€ âŒ ä¸è¦ Rigidbody/Rigidbody2D
â”œâ”€â”€ âŒ ä¸è¦ Collider/Collider2D
â””â”€â”€ âŒ ä¸è¦ DropAnimation
```

**æ­¥éª¤ï¼š**
1. åˆ›å»ºç©ºGameObject
2. æ·»åŠ  SpriteRendererï¼ˆ2Dï¼‰æˆ–æ¨¡å‹ï¼ˆ3Dï¼‰
3. **ä¸è¦æ·»åŠ **ä»»ä½•ç‰©ç†ç»„ä»¶
4. ä¿å­˜ä¸ºé¢„åˆ¶ä½“
5. æ‹–åˆ° StackController.objectPrefab

### å¦‚æœé¢„åˆ¶ä½“éœ€è¦ç‰©ç†ï¼ˆå…¶ä»–ç”¨é€”ï¼‰

å¦‚æœé¢„åˆ¶ä½“åœ¨å…¶ä»–åœ°æ–¹éœ€è¦ç‰©ç†ï¼š

**æ–¹æ¡ˆA: åˆ›å»ºä¸“ç”¨å †å ç‰ˆæœ¬**
```
MyObject_Physicsï¼ˆæœ‰Rigidbodyï¼‰â† å…¶ä»–åœ°æ–¹ç”¨
MyObject_Stackï¼ˆæ— Rigidbodyï¼‰  â† å †å ç³»ç»Ÿç”¨
```

**æ–¹æ¡ˆB: è¿è¡Œæ—¶æ·»åŠ ç‰©ç†**
```csharp
// åœ¨éœ€è¦ç‰©ç†çš„åœ°æ–¹æ‰æ·»åŠ 
if (needPhysics)
{
    gameObject.AddComponent<Rigidbody>();
}
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰

| é—®é¢˜ | å½±å“ |
|------|------|
| é¢„åˆ¶ä½“æœ‰Rigidbody | åˆ›å»ºæ—¶å°±ä¸‹è½ |
| æ— ç»„ä»¶æ¸…ç† | ç‰©ç†æ•ˆæœæ— æ³•æ§åˆ¶ |
| æ— éªŒè¯æ—¥å¿— | éš¾ä»¥è¯Šæ–­é—®é¢˜ |

### ä¿®å¤å

| æ”¹è¿› | æ•ˆæœ |
|------|------|
| âœ… è‡ªåŠ¨ç§»é™¤Rigidbody | ç‰©ä½“é™æ­¢ |
| âœ… è‡ªåŠ¨ç§»é™¤Rigidbody2D | 2Dç‰©ä½“ä¹Ÿé™æ­¢ |
| âœ… ç§»é™¤DropAnimation | ä¸ä¼šæ„å¤–æ‰è½ |
| âœ… éªŒè¯çˆ¶å¯¹è±¡ | ç¡®ä¿æ­£ç¡®ç®¡ç† |
| âœ… è¯¦ç»†æ—¥å¿— | ä¾¿äºè°ƒè¯• |

---

## ğŸ”§ é«˜çº§è°ƒè¯•

### ä¸´æ—¶è°ƒè¯•è„šæœ¬

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œåˆ›å»ºæ­¤è„šæœ¬æ£€æŸ¥ï¼š

```csharp
using UnityEngine;

public class StackObjectDebugger : MonoBehaviour
{
    void Start()
    {
        Invoke("DebugStackObjects", 1f);
    }
    
    void DebugStackObjects()
    {
        StackController stack = FindObjectOfType<StackController>();
        if (stack == null) return;
        
        Debug.Log("=== å †å ç‰©ä½“è¯Šæ–­ ===");
        
        foreach (var obj in stack.stackedObjects)
        {
            if (obj == null) continue;
            
            Debug.Log($"\nç‰©ä½“: {obj.name}");
            Debug.Log($"  ä½ç½®: {obj.transform.position}");
            Debug.Log($"  çˆ¶å¯¹è±¡: {obj.transform.parent?.name ?? "æ— "}");
            
            // æ£€æŸ¥ç‰©ç†ç»„ä»¶
            var rb = obj.GetComponent<Rigidbody>();
            var rb2d = obj.GetComponent<Rigidbody2D>();
            var drop = obj.GetComponent<DropAnimation>();
            
            Debug.Log($"  Rigidbody: {rb != null}");
            Debug.Log($"  Rigidbody2D: {rb2d != null}");
            Debug.Log($"  DropAnimation: {drop != null}");
            
            if (rb != null)
            {
                Debug.LogError($"  âš ï¸ è­¦å‘Šï¼š{obj.name} æœ‰ Rigidbodyï¼");
            }
            if (rb2d != null)
            {
                Debug.LogError($"  âš ï¸ è­¦å‘Šï¼š{obj.name} æœ‰ Rigidbody2Dï¼");
            }
            if (drop != null)
            {
                Debug.LogError($"  âš ï¸ è­¦å‘Šï¼š{obj.name} æœ‰ DropAnimationï¼");
            }
        }
        
        Debug.Log("==================");
    }
}
```

---

## âœ… ä¿®å¤æ€»ç»“

**ä¿®å¤å†…å®¹ï¼š**
1. âœ… è‡ªåŠ¨ç§»é™¤é¢„åˆ¶ä½“ä¸Šçš„æ‰€æœ‰ç‰©ç†ç»„ä»¶
2. âœ… ç§»é™¤é»˜è®¤ç«‹æ–¹ä½“çš„ç‰©ç†ç»„ä»¶
3. âœ… ç§»é™¤å¯èƒ½å­˜åœ¨çš„ DropAnimation
4. âœ… éªŒè¯çˆ¶å¯¹è±¡è®¾ç½®
5. âœ… å¢å¼ºæ—¥å¿—è¾“å‡º

**é¢„æœŸæ•ˆæœï¼š**
- âœ… ç‰©ä½“åˆ›å»ºåé™æ­¢ä¸åŠ¨
- âœ… ä»…åœ¨å€¾å€’é˜¶æ®µæ‰æ‰è½
- âœ… Console æ˜¾ç¤ºè¯¦ç»†ç»„ä»¶ä¿¡æ¯
- âœ… è‡ªåŠ¨æ¸…ç†é—®é¢˜ç»„ä»¶

**æµ‹è¯•éªŒè¯ï¼š**
- âœ… åˆ›å»ºæ—¶ç‰©ä½“ä¸åŠ¨
- âœ… å±…ä¸­/å€¾æ–œé˜¶æ®µç‰©ä½“ä¸åŠ¨
- âœ… å€¾å€’é˜¶æ®µç‰©ä½“æ‰è½
- âœ… Console æ— ç‰©ç†ç»„ä»¶è­¦å‘Š

---

**ä¿®å¤ç‰ˆæœ¬**: 1.1.4  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: âœ… å·²éªŒè¯


