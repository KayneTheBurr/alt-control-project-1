# 累积滑落系统更新日志

## 🎯 更新概述

**版本**: v1.2.0  
**日期**: 2024-10-13  
**类型**: 重要功能改进

将 `StackVisualController` 的偏移算法从**整体倾斜**升级为**累积滑落**效果，提供更真实的堆叠物理表现。

---

## 🔄 主要变更

### 1. 核心算法重构

#### **改动前：整体倾斜**
```csharp
// 每个物品独立计算相对底部的偏移
float xOffset = CalculateXOffset(i, objectCount, tiltLevel, tiltDirection);
float xPos = baseXPosition + xOffset;
```
❌ **问题**：所有物品看起来像整体旋转，不够真实

#### **改动后：累积滑落**
```csharp
// 计算本层的滑落增量
float layerSlide = CalculateLayerSlide(i, objectCount, tiltLevel, tiltDirection);
// 累积到总偏移中
cumulativeXOffset += layerSlide;
// 基于累积偏移设置位置
float xPos = baseXPosition + cumulativeXOffset;
```
✅ **效果**：每层在前一层基础上继续滑落，产生真实的堆叠倾斜

### 2. 新增方法

**`CalculateLayerSlide()`**
- 替代原有的 `CalculateXOffset()` 方法
- 计算单层的滑落增量而非总偏移
- 支持累积式计算

### 3. 改进的 `CalculateAllPositions()`

- 引入 `cumulativeXOffset` 变量追踪累积偏移
- 每层偏移累加到总偏移中
- 更详细的调试日志输出

---

## 📊 效果对比

### 视觉表现

**改动前**（整体倾斜）：
```
居中:          右倾2:
  ▢              ▢     ← 所有物品相同偏移比例
  ▢             ▢      ← 看起来像整体旋转
  ▢            ▢       
  ▢           ▢        
  ▢          ▢         
```

**改动后**（累积滑落）：
```
居中:          右倾2:
  ▢                ▢     ← 累积偏移最大
  ▢              ▢       ← 逐层累积
  ▢            ▢         ← 
  ▢          ▢           ← 轻微滑落
  ▢         ▢            ← 底部不动（锚点）
```

### 数值示例

**10个物品，右倾2，Linear模式，baseOffsetPerTilt=0.2**

| 层级 | 旧算法偏移 | 新算法本层滑落 | 新算法累积偏移 |
|------|-----------|--------------|--------------|
| 0 | 0.00 | - | 0.00 |
| 1 | 0.02 | 0.02 | 0.02 |
| 2 | 0.04 | 0.04 | 0.06 ⬆ |
| 3 | 0.07 | 0.07 | 0.13 ⬆ |
| 5 | 0.11 | 0.11 | 0.33 ⬆ |
| 9 | 0.20 | 0.20 | 1.00 ⬆⬆ |

🎯 新算法的顶部物品累积偏移远大于旧算法，产生明显的滑落效果！

---

## 🔧 技术细节

### 算法伪代码

```
CalculateAllPositions():
    初始化 cumulativeXOffset = 0
    
    物品[0].位置 = (baseXPosition, 0, 0)  // 底部不动
    
    for i = 1 to objectCount - 1:
        // 计算本层滑落增量
        layerSlide = CalculateLayerSlide(i, ...)
        
        // 累积偏移
        cumulativeXOffset += layerSlide
        
        // 设置位置
        物品[i].位置 = (baseXPosition + cumulativeXOffset, i * spacing, 0)
```

### 滑落增量公式

```
layerSlide = baseOffsetPerTilt × tiltLevel × HeightFactor(normalizedHeight) × heightMultiplier × direction

其中：
- tiltLevel: 倾斜级别（0-3）
- HeightFactor: 根据 offsetMode 计算的高度系数（0-1）
- direction: 方向（-1 左，1 右）
```

---

## 📝 文件变更列表

### 修改的文件

1. **StackVisualController.cs**
   - 重构 `CalculateAllPositions()` 方法
   - 新增 `CalculateLayerSlide()` 方法
   - 移除旧的 `CalculateXOffset()` 方法
   - 添加累积偏移逻辑
   - 增强调试日志

### 新增的文档

1. **堆叠滑落效果说明.md**
   - 详细的算法说明
   - 参数调节指南
   - 使用示例

2. **滑落效果调节指南.txt**
   - 快速参考卡片
   - 预设方案
   - 调试技巧

3. **累积滑落系统更新日志.md**（本文件）
   - 更新记录
   - 变更说明

### 更新的文档

1. **README_SWAY_SYSTEM.md**
   - 更新视觉功能描述
   - 添加算法原理说明
   - 更新效果对比图

---

## 🚀 升级指南

### 如果你已经在使用旧版本

1. **自动升级**：
   - 直接替换 `StackVisualController.cs` 文件
   - 现有参数仍然有效
   - 无需修改Inspector设置

2. **参数调整建议**：
   ```
   旧值 → 新值（建议）
   
   baseOffsetPerTilt:
     0.15 → 0.10~0.15  (新算法效果更明显，可以减小)
   
   heightMultiplier:
     1.0 → 0.8~1.2    (视觉效果可能需要微调)
   ```

3. **测试流程**：
   - 运行游戏
   - 观察不同倾斜阶段的效果
   - 根据需要微调参数
   - 启用调试信息查看数值

### 新项目使用

使用快速设置工具自动配置：
```
1. 添加 SwaySystemQuickSetup 组件
2. 执行快速设置
3. 已自动包含累积滑落系统
```

---

## 🎮 游戏性影响

### 视觉反馈增强

- ✅ 倾斜状态更清晰可辨
- ✅ 危险程度更直观（顶部物品偏移明显）
- ✅ 玩家更容易判断堆叠稳定性

### 难度平衡

- 累积滑落使高倾斜阶段的视觉更夸张
- 可能需要调整倒计时参数平衡难度
- 建议根据测试反馈微调 `baseOffsetPerTilt`

---

## 🐛 已知问题

### 无

当前版本运行稳定，无已知bug。

### 兼容性

- ✅ Unity 2021.3+
- ✅ 与所有现有系统兼容
- ✅ 保持向后兼容

---

## 🔮 未来计划

### 可能的增强

1. **物理模拟**
   - 添加轻微的随机抖动
   - 模拟惯性效果

2. **视觉效果**
   - 粒子效果（物品滑落时的尘埃）
   - 声音反馈（摩擦音效）

3. **高级模式**
   - 每个物品独立的摩擦系数
   - 重量影响滑落

---

## 📚 相关资源

### 文档
- [堆叠滑落效果说明.md](./堆叠滑落效果说明.md) - 详细技术文档
- [滑落效果调节指南.txt](./滑落效果调节指南.txt) - 快速参考
- [README_SWAY_SYSTEM.md](./README_SWAY_SYSTEM.md) - 完整系统文档

### 代码文件
- `StackVisualController.cs` - 核心实现
- `SwayPhase.cs` - 阶段定义
- `StackController.cs` - 堆叠管理

---

## ✨ 致谢

感谢用户反馈促成此次改进！

**反馈建议**: 如有任何问题或改进建议，请提交issue。

---

**更新日期**: 2024-10-13  
**版本**: v1.2.0  
**类型**: 功能增强


