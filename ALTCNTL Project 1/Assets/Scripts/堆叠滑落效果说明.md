# 堆叠滑落效果系统说明

## 📋 概述

修改了 `StackVisualController` 的偏移计算算法，从**整体倾斜**改为**累积滑落**效果，让堆叠的物品在倾斜时产生更真实的视觉表现。

---

## 🔄 修改内容

### 核心算法变更

#### **之前的逻辑（整体倾斜）**
```csharp
// 每个物品相对于底部基准点独立计算偏移
float xOffset = CalculateXOffset(i, objectCount, tiltLevel, tiltDirection);
float xPos = baseXPosition + xOffset;
```
- **问题**：所有物品都是相对于底部计算偏移，导致看起来像整体旋转

#### **现在的逻辑（累积滑落）**
```csharp
// 每层计算滑落增量
float layerSlide = CalculateLayerSlide(i, objectCount, tiltLevel, tiltDirection);
// 累积到总偏移中
cumulativeXOffset += layerSlide;
// 基于累积偏移设置位置
float xPos = baseXPosition + cumulativeXOffset;
```
- **效果**：每个物品在下方物品的基础上继续滑落，产生真实的堆叠倾斜效果

---

## ⚙️ 工作原理

### 1. **滑落增量计算**
```csharp
float CalculateLayerSlide(int objectIndex, int totalCount, int tiltLevel, int tiltDirection)
```

**参数说明**：
- `objectIndex`: 物品在堆叠中的索引（0为底部）
- `totalCount`: 总物品数量
- `tiltLevel`: 倾斜级别（0-3，对应居中到倾倒）
- `tiltDirection`: 倾斜方向（-1左，0居中，1右）

**计算步骤**：
1. 计算归一化高度：`normalizedHeight = objectIndex / (totalCount - 1)`
2. 获取基础滑落量：`baseSlide = baseOffsetPerTilt * tiltLevel`
3. 应用高度系数：`heightFactor = CalculateHeightFactor(normalizedHeight)`
4. 最终滑落：`layerSlide = baseSlide * heightFactor * heightMultiplier * tiltDirection`

### 2. **累积偏移系统**

```
物品0（底部）: X偏移 = 0
物品1:         X偏移 = 0 + 滑落增量1
物品2:         X偏移 = 0 + 滑落增量1 + 滑落增量2
物品3:         X偏移 = 0 + 滑落增量1 + 滑落增量2 + 滑落增量3
...
```

### 3. **高度影响模式**

支持4种偏移模式（通过 `offsetMode` 设置）：

| 模式 | 说明 | 效果 |
|------|------|------|
| **Linear** | 线性增长 | 均匀的滑落增量 |
| **Exponential** | 指数增长 | 越高滑落越剧烈 |
| **Sine** | 正弦曲线 | 更自然的物理表现 |
| **Custom** | 自定义曲线 | 完全自定义的滑落曲线 |

---

## 🎮 参数调节

### Inspector 面板参数

1. **Base Offset Per Tilt**（基础偏移量）
   - 每个倾斜级别的基础滑落距离
   - 建议值：`0.1` - `0.3`
   - 数值越大，滑落越明显

2. **Height Multiplier**（高度影响系数）
   - 控制高度对滑落的影响程度
   - 范围：`0` - `2`
   - `0`：所有物品滑落相同
   - `1`：标准影响
   - `2`：高处物品滑落加倍

3. **Offset Mode**（偏移模式）
   - **Linear**：适合规则堆叠
   - **Exponential**：适合戏剧化效果
   - **Sine**：适合自然物理表现
   - **Custom**：使用自定义曲线调节

4. **Object Spacing**（物品间隔）
   - Y轴堆叠间距
   - 影响视觉层次感

5. **Smooth Time**（平滑时间）
   - 位置变化的过渡时间
   - 建议值：`0.1` - `0.3`秒

---

## 📊 视觉效果对比

### 倾斜级别对应效果

| 阶段 | 倾斜级别 | 角度 | 滑落效果 |
|------|---------|------|----------|
| 居中 | 0 | 0° | 无滑落 |
| 左倾1/右倾1 | 1 | ±15° | 轻微滑落 |
| 左倾2/右倾2 | 2 | ±25° | 中度滑落 |
| 左倾倒/右倾倒 | 3 | ±35° | 明显滑落 |

### 堆叠高度对滑落的影响

以10个物品、右倾2（级别2）、Linear模式为例：

```
物品 | 归一化高度 | 高度系数 | 本层滑落 | 累积偏移
-----|-----------|---------|---------|----------
  0  |    0.00   |   0.00  |   0.00  |   0.00
  1  |    0.11   |   0.11  |   0.02  |   0.02
  2  |    0.22   |   0.22  |   0.04  |   0.06
  3  |    0.33   |   0.33  |   0.07  |   0.13
  4  |    0.44   |   0.44  |   0.09  |   0.22
  5  |    0.56   |   0.56  |   0.11  |   0.33
  6  |    0.67   |   0.67  |   0.13  |   0.46
  7  |    0.78   |   0.78  |   0.16  |   0.62
  8  |    0.89   |   0.89  |   0.18  |   0.80
  9  |    1.00   |   1.00  |   0.20  |   1.00
```

---

## 🔍 调试功能

### 控制台日志
设置 `logOffsetCalculations = true` 查看详细计算信息：
```
[StackVisual] 物体 3: 本层滑落=0.067, 累积偏移=0.133, 目标位置=(0.13, 3.00, 0.00)
```

### Scene 视图可视化
- **黄色连线**：物品之间的连接
- **绿色垂直线**：基准X轴位置
- **红色横线**：物品相对基准的偏移量

### GUI 调试面板
显示实时信息：
- 当前阶段
- 物品数量
- 每个物品的X位置和偏移量

---

## 📝 使用示例

### 调整参数获得不同效果

#### 1. **轻微真实效果**
```
baseOffsetPerTilt = 0.1
heightMultiplier = 1.0
offsetMode = Sine
```

#### 2. **戏剧化效果**
```
baseOffsetPerTilt = 0.3
heightMultiplier = 1.5
offsetMode = Exponential
```

#### 3. **均匀滑落**
```
baseOffsetPerTilt = 0.2
heightMultiplier = 0.5
offsetMode = Linear
```

---

## 🐛 故障排除

### 问题：滑落效果不明显
**解决方案**：
- 增大 `baseOffsetPerTilt`
- 增大 `heightMultiplier`
- 检查倾斜阶段是否正确触发

### 问题：物品移动太快/太慢
**解决方案**：
- 调整 `smoothTime`
- 或关闭平滑移动：`useSmoothMovement = false`

### 问题：物品排列不自然
**解决方案**：
- 尝试不同的 `offsetMode`
- 使用 `Custom` 模式并调整曲线

---

## 🔗 相关文件

- **StackVisualController.cs** - 视觉控制主脚本
- **SwayPhase.cs** - 倾斜阶段定义
- **StackController.cs** - 堆叠管理
- **SwayController.cs** - 摇摆控制

---

## 📅 更新记录

**2024-10-13**
- ✅ 实现累积滑落算法
- ✅ 修改偏移计算逻辑
- ✅ 添加详细调试信息
- ✅ 优化视觉效果

---

## 💡 技术要点

1. **累积偏移**：每层在前一层基础上继续滑落
2. **高度影响**：越高的物品，滑落增量越大
3. **阶段响应**：倾斜级别越高，滑落幅度越大
4. **平滑过渡**：使用 SmoothDamp 实现自然的移动动画
5. **模式多样**：支持多种偏移曲线模式

---

## 🎯 效果预期

修改后，堆叠倾斜时应该呈现：
- ✅ 底部物品基本不动
- ✅ 中层物品适度滑落
- ✅ 顶部物品明显滑落
- ✅ 倾斜越大，整体滑落越明显
- ✅ 阶段切换时平滑过渡

这样就能模拟出真实的物理堆叠倾斜效果！


