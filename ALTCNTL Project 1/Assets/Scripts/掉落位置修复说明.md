# æ‰è½ä½ç½®ä¿®å¤è¯´æ˜

> **ä¿®å¤å†…å®¹**: ç‰©ä½“ä»å½“å‰æ‰€åœ¨ä½ç½®å¼€å§‹æ‰è½  
> **ä¿®å¤æ—¥æœŸ**: 2025-10-13  
> **ç‰ˆæœ¬**: 1.1.5

---

## ğŸ¯ ä¿®å¤ç›®æ ‡

ç¡®ä¿ç‰©ä½“åœ¨å€¾å€’æ‰è½æ—¶ï¼Œ**ä»å½“å‰æ‰€åœ¨çš„å®é™…ä½ç½®å¼€å§‹æ‰è½**ï¼Œè€Œä¸æ˜¯ä½ç½®å‘ç”Ÿè·³å˜ã€‚

---

## ğŸ› ä¿®å¤å‰çš„é—®é¢˜

### é—®é¢˜ç°è±¡
- ç‰©ä½“æ‰è½æ—¶ä½ç½®ä¼šçªç„¶æ”¹å˜
- æ‰è½ä¸æ˜¯ä»ç‰©ä½“å½“å‰ä½ç½®å¼€å§‹
- è§†è§‰ä¸Šä¸è¿è´¯ï¼Œæœ‰è·³è·ƒæ„Ÿ

### åŸå› åˆ†æ

**é—®é¢˜ä»£ç ï¼š**
```csharp
// ä¿®å¤å‰
droppedObject.transform.SetParent(transform.parent);
// âŒ é»˜è®¤ worldPositionStays = false
// âŒ æ”¹å˜çˆ¶å¯¹è±¡æ—¶ï¼Œæœ¬åœ°åæ ‡ä¿æŒä¸å˜ï¼Œä¸–ç•Œåæ ‡ä¼šæ”¹å˜ï¼
```

**é—®é¢˜è§£é‡Šï¼š**

å½“ç‰©ä½“åœ¨ `StackRoot` ä¸‹æ—¶ï¼š
- StackRoot å¯èƒ½æœ‰æ—‹è½¬ï¼ˆè¢« SwayController æ—‹è½¬ï¼‰
- ç‰©ä½“çš„æœ¬åœ°åæ ‡ â‰  ä¸–ç•Œåæ ‡

ç§»å‡º StackRoot æ—¶ï¼š
```
ç‰©ä½“åœ¨ StackRoot ä¸‹:
  æœ¬åœ°ä½ç½®: (0, 4, 0)
  ä¸–ç•Œä½ç½®: (0.3, 4.2, 0)  â† å› ä¸º StackRoot æ—‹è½¬äº†

SetParent(null) é»˜è®¤è¡Œä¸º:
  ä¿æŒæœ¬åœ°ä½ç½®: (0, 4, 0)
  æ–°çš„ä¸–ç•Œä½ç½®: (0, 4, 0)  â† ä½ç½®è·³å˜ï¼âŒ
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: ä¿å­˜ä¸–ç•Œä½ç½®

```csharp
// åœ¨ç§»å‡ºçˆ¶å¯¹è±¡å‰ï¼Œä¿å­˜ä¸–ç•Œä½ç½®å’Œæ—‹è½¬
Vector3 worldPosition = droppedObject.transform.position;
Quaternion worldRotation = droppedObject.transform.rotation;
```

### ä¿®å¤2: ä½¿ç”¨ worldPositionStays å‚æ•°

```csharp
// SetParent çš„ç¬¬äºŒä¸ªå‚æ•°è®¾ä¸º true
droppedObject.transform.SetParent(transform.parent, true); 
// âœ… worldPositionStays = true
// âœ… ä¸–ç•Œåæ ‡ä¿æŒä¸å˜ï¼
```

### ä¿®å¤3: ç¡®ä¿ä½ç½®æ­£ç¡®

```csharp
// ä»¥é˜²ä¸‡ä¸€ï¼Œå†æ¬¡ç¡®è®¤ä½ç½®
droppedObject.transform.position = worldPosition;
droppedObject.transform.rotation = worldRotation;
```

---

## ğŸ“‹ å®Œæ•´ä¿®å¤ä»£ç 

### OnToppleDrop() æ–¹æ³•

```csharp
void OnToppleDrop()
{
    if (stackedObjects.Count == 0)
    {
        if (logDropEvents)
        {
            Debug.LogWarning("[StackController] å †å å·²ç©ºï¼Œæ— æ³•æ‰è½ç‰©ä½“");
        }
        return;
    }

    GameObject droppedObject = RemoveTopObject();
    
    if (droppedObject == null) return;

    // ä¿®å¤ï¼šä¿å­˜å½“å‰ä¸–ç•Œä½ç½®å’Œæ—‹è½¬
    Vector3 worldPosition = droppedObject.transform.position;
    Quaternion worldRotation = droppedObject.transform.rotation;

    if (logDropEvents)
    {
        Debug.Log($"[StackController] æ‰è½ç‰©ä½“: {droppedObject.name}");
        Debug.Log($"  - æ‰è½ä½ç½®: {worldPosition}");  // æ–°å¢ï¼šæ˜¾ç¤ºæ‰è½ä½ç½®
        Debug.Log($"  - å‰©ä½™ç‰©ä½“: {stackedObjects.Count}");
    }

    // ä¿®å¤ï¼šä¿æŒä¸–ç•Œä½ç½®
    droppedObject.transform.SetParent(transform.parent, true); // worldPositionStays = true
    
    // ä¿®å¤ï¼šç¡®ä¿ä½ç½®æ­£ç¡®
    droppedObject.transform.position = worldPosition;
    droppedObject.transform.rotation = worldRotation;
    
    // åº”ç”¨æ‰è½æ•ˆæœ
    ApplyDropEffect(droppedObject);

    // è®¾ç½®è‡ªåŠ¨é”€æ¯
    Destroy(droppedObject, droppedObjectLifetime);
}
```

### ApplyDropEffect() å¢å¼ºæ—¥å¿—

```csharp
void ApplyDropEffect(GameObject obj)
{
    // æ·»åŠ ç®€å•çš„æ‰è½åŠ¨ç”»ç»„ä»¶
    DropAnimation dropAnim = obj.AddComponent<DropAnimation>();
    
    // è®¡ç®—æ‰è½æ–¹å‘ï¼ˆåŸºäºå½“å‰æ‘‡æ‘†æ–¹å‘ï¼‰
    float direction = 0f;
    if (swayController != null)
    {
        direction = swayController.CurrentPhase.GetDirection();
    }
    
    // è®¾ç½®æ‰è½å‚æ•°ï¼ˆä»å½“å‰ä½ç½®å¼€å§‹ï¼‰
    dropAnim.dropVelocity = new Vector2(direction * dropForce, -dropForce * 0.5f);
    dropAnim.angularVelocity = Random.Range(-dropTorque, dropTorque) * 100f;
    dropAnim.gravity = 9.81f;
    
    // æ–°å¢ï¼šè¯¦ç»†æ—¥å¿—
    if (logDropEvents)
    {
        Debug.Log($"[StackController] æ‰è½åŠ¨ç”»è®¾ç½®:");
        Debug.Log($"  - åˆå§‹é€Ÿåº¦: {dropAnim.dropVelocity}");
        Debug.Log($"  - è§’é€Ÿåº¦: {dropAnim.angularVelocity}");
        Debug.Log($"  - æ–¹å‘: {(direction < 0 ? "å·¦" : direction > 0 ? "å³" : "ä¸­")}");
    }
}
```

---

## ğŸ” éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥Consoleæ—¥å¿—

è¿è¡Œæ¸¸æˆå¹¶è¿›å…¥å€¾å€’é˜¶æ®µï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
[StackController] æ‰è½ç‰©ä½“: StackObject_4
  - æ‰è½ä½ç½®: (0.35, 4.12, 0)  â† å½“å‰å®é™…ä½ç½®
  - å‰©ä½™ç‰©ä½“: 4
[StackController] æ‰è½åŠ¨ç”»è®¾ç½®:
  - åˆå§‹é€Ÿåº¦: (5.0, -2.5)
  - è§’é€Ÿåº¦: 156.8
  - æ–¹å‘: å³
```

### 2. è§‚å¯Ÿè§†è§‰æ•ˆæœ

**ä¿®å¤å‰ï¼š**
- ç‰©ä½“æ‰è½æ—¶ä¼š"è·³"ä¸€ä¸‹
- ä½ç½®çªç„¶æ”¹å˜
- ä¸è¿è´¯

**ä¿®å¤åï¼š**
- âœ… ç‰©ä½“ä»å½“å‰ä½ç½®å¹³æ»‘æ‰è½
- âœ… æ— ä½ç½®è·³å˜
- âœ… è§†è§‰è¿è´¯è‡ªç„¶

### 3. åœºæ™¯è§†å›¾éªŒè¯

åœ¨ Scene è§†å›¾ä¸­è§‚å¯Ÿï¼š
- æš‚åœæ¸¸æˆ
- æŸ¥çœ‹ç‰©ä½“æ‰è½ç¬é—´
- ä½ç½®åº”è¯¥è¿ç»­ï¼Œæ— è·³è·ƒ

---

## ğŸ“Š ä¿®å¤å¯¹æ¯”

### ä¿®å¤å‰

```csharp
// ä¿®å¤å‰çš„é—®é¢˜
SetParent(parent);  // worldPositionStays é»˜è®¤ false

ç»“æœï¼š
  StackRoot æ—‹è½¬ 15Â° æ—¶
  ç‰©ä½“æœ¬åœ°ä½ç½® (0, 4, 0)
  ç‰©ä½“ä¸–ç•Œä½ç½® (0.3, 4.1, 0)  â† å®é™…ä½ç½®
  
  ç§»å‡ºåï¼š
  æ–°ä¸–ç•Œä½ç½® = æœ¬åœ°ä½ç½® = (0, 4, 0)  â† è·³å˜ï¼âŒ
  åç§»äº† 0.3 å•ä½
```

### ä¿®å¤å

```csharp
// ä¿®å¤å
Vector3 worldPos = obj.transform.position;  // ä¿å­˜ (0.3, 4.1, 0)
SetParent(parent, true);  // worldPositionStays = true
obj.transform.position = worldPos;  // ç¡®ä¿ä½ç½®

ç»“æœï¼š
  ç§»å‡ºåä¸–ç•Œä½ç½® = (0.3, 4.1, 0)  â† ä¿æŒä¸å˜ï¼âœ…
  ä»å½“å‰ä½ç½®å¼€å§‹æ‰è½
```

---

## ğŸ¯ ç†è§£ SetParent å‚æ•°

### SetParent(parent, worldPositionStays)

**worldPositionStays = false (é»˜è®¤):**
```
ä¿æŒæœ¬åœ°åæ ‡ä¸å˜
ä¸–ç•Œåæ ‡ä¼šæ”¹å˜ âŒ
```

**worldPositionStays = true:**
```
ä¿æŒä¸–ç•Œåæ ‡ä¸å˜ âœ…
æœ¬åœ°åæ ‡ä¼šè‡ªåŠ¨è°ƒæ•´
```

### ç¤ºä¾‹

```csharp
// å‡è®¾ç‰©ä½“åœ¨æ—‹è½¬çš„çˆ¶å¯¹è±¡ä¸‹
GameObject obj;
Transform rotatedParent;  // æ—‹è½¬äº† 30Â°

// ç‰©ä½“çŠ¶æ€ï¼š
obj.transform.localPosition = (0, 5, 0);
obj.transform.position = (1.5, 5.2, 0);  // å› ä¸ºçˆ¶å¯¹è±¡æ—‹è½¬

// ç§»å‡ºçˆ¶å¯¹è±¡ï¼š

// æ–¹å¼1ï¼ˆé”™è¯¯ï¼‰ï¼š
obj.transform.SetParent(null);  // é»˜è®¤ false
// ç»“æœï¼šposition = (0, 5, 0)  â† è·³å˜ï¼

// æ–¹å¼2ï¼ˆæ­£ç¡®ï¼‰ï¼š
obj.transform.SetParent(null, true);
// ç»“æœï¼šposition = (1.5, 5.2, 0)  â† ä¿æŒä¸å˜ï¼
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### ç§»åŠ¨ç‰©ä½“åˆ°æ–°çˆ¶å¯¹è±¡æ—¶

**æ¨èåšæ³•ï¼š**
```csharp
// 1. ä¿å­˜ä¸–ç•Œåæ ‡
Vector3 worldPos = obj.transform.position;
Quaternion worldRot = obj.transform.rotation;

// 2. ä½¿ç”¨ worldPositionStays = true
obj.transform.SetParent(newParent, true);

// 3. ç¡®è®¤ä½ç½®ï¼ˆå¯é€‰ï¼Œä½†æ›´å®‰å…¨ï¼‰
obj.transform.position = worldPos;
obj.transform.rotation = worldRot;
```

### éœ€è¦ä¿æŒä¸–ç•Œä½ç½®çš„æƒ…å†µ

- âœ… ç‰©ä½“æ‰è½
- âœ… ç‰©ä½“ä»å®¹å™¨ä¸­å–å‡º
- âœ… ç‰©ä½“åœ¨ä¸åŒå±‚çº§é—´ç§»åŠ¨
- âœ… ä»»ä½•éœ€è¦è§†è§‰è¿è´¯çš„åœºæ™¯

### å¯ä»¥ä¸ä¿æŒä¸–ç•Œä½ç½®çš„æƒ…å†µ

- ç‰©ä½“åˆšåˆ›å»ºï¼Œè®¾ç½®åˆå§‹çˆ¶å¯¹è±¡
- ç‰©ä½“è¢«æ”¾å…¥å®¹å™¨ï¼Œéœ€è¦é‡ç½®ä½ç½®
- æ˜ç¡®éœ€è¦æ”¹å˜ä½ç½®çš„åœºæ™¯

---

## ğŸ”§ æ‰©å±•åŠŸèƒ½

### è®°å½•æ‰è½è½¨è¿¹ï¼ˆå¯é€‰ï¼‰

```csharp
// åœ¨ ApplyDropEffect ä¸­æ·»åŠ 
void ApplyDropEffect(GameObject obj)
{
    // ... ç°æœ‰ä»£ç  ...
    
    // å¯é€‰ï¼šè®°å½•æ‰è½èµ·å§‹ç‚¹
    DropAnimation dropAnim = obj.AddComponent<DropAnimation>();
    dropAnim.startPosition = obj.transform.position;  // è®°å½•èµ·ç‚¹
    
    // å¯é€‰ï¼šç»˜åˆ¶è½¨è¿¹
    if (showDropTrail)
    {
        LineRenderer trail = obj.AddComponent<LineRenderer>();
        // é…ç½®è½¨è¿¹æ¸²æŸ“...
    }
}
```

### æ‰è½ä½ç½®åç§»ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦æ‰è½æ—¶ç¨å¾®åç§»ï¼š

```csharp
// åœ¨ OnToppleDrop ä¸­
Vector3 worldPosition = droppedObject.transform.position;

// æ·»åŠ éšæœºåç§»ï¼ˆå¯é€‰ï¼‰
worldPosition += new Vector3(
    Random.Range(-0.1f, 0.1f),  // x è½´éšæœº
    0,
    0
);

droppedObject.transform.position = worldPosition;
```

---

## âœ… ä¿®å¤æ€»ç»“

**ä¿®å¤å†…å®¹ï¼š**
1. âœ… ä¿å­˜ç‰©ä½“çš„ä¸–ç•Œä½ç½®å’Œæ—‹è½¬
2. âœ… ä½¿ç”¨ `SetParent(parent, true)` ä¿æŒä¸–ç•Œåæ ‡
3. âœ… ç¡®è®¤ä½ç½®è®¾ç½®æ­£ç¡®
4. âœ… å¢å¼ºæ—¥å¿—è¾“å‡ºæ‰è½ä½ç½®ä¿¡æ¯

**ä¿®å¤æ•ˆæœï¼š**
- âœ… ç‰©ä½“ä»å½“å‰ä½ç½®å¼€å§‹æ‰è½
- âœ… æ— ä½ç½®è·³å˜
- âœ… è§†è§‰è¿è´¯è‡ªç„¶
- âœ… è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯

**éªŒè¯æ–¹æ³•ï¼š**
- âœ… Console æ˜¾ç¤ºæ‰è½ä½ç½®
- âœ… Scene è§†å›¾è§‚å¯Ÿè¿è´¯æ€§
- âœ… æ¸¸æˆè§†å›¾æ£€æŸ¥è§†è§‰æ•ˆæœ

---

**ä¿®å¤ç‰ˆæœ¬**: 1.1.5  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: âœ… å·²éªŒè¯  
**å…¼å®¹æ€§**: å®Œå…¨å‘åå…¼å®¹


