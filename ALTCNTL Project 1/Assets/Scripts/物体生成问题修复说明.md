# ç‰©ä½“ç”Ÿæˆé—®é¢˜ä¿®å¤è¯´æ˜

> **ä¿®å¤æ—¥æœŸ**: 2025-10-13  
> **ç‰ˆæœ¬**: 1.1.2  
> **é—®é¢˜**: IndexOutOfRangeException å’Œ ç‰©ä½“æœªç”Ÿæˆ

---

## ğŸ› ä¿®å¤çš„é—®é¢˜

### é—®é¢˜1: IndexOutOfRangeException

**é”™è¯¯ä¿¡æ¯:**
```
IndexOutOfRangeException: Index was outside the bounds of the array.
ObjectPlacer.CreatePreviewObject () (at Assets/Scripts/ObjectPlacer.cs:216)
```

**åŸå› :**
- `currentPrefabIndex` å¯èƒ½è¶…å‡º `placeablePrefabs` æ•°ç»„èŒƒå›´
- æ²¡æœ‰åœ¨è®¿é—®æ•°ç»„å‰éªŒè¯ç´¢å¼•

### é—®é¢˜2: åœºæ™¯ä¸­çœ‹ä¸åˆ°ç”Ÿæˆçš„ç‰©ä½“

**ç°è±¡:**
- è®¾ç½®äº† `initialStackCount` ä½†çœ‹ä¸åˆ°ç‰©ä½“
- Hierarchyä¸­æ²¡æœ‰æ˜¾ç¤ºåˆ›å»ºçš„ç‰©ä½“

**å¯èƒ½åŸå› :**
- ç‰©ä½“åœ¨ `StackRoot` ä¸‹åˆ›å»ºï¼ŒHierarchyæœªå±•å¼€
- ç‰©ä½“ä½ç½®ä¸åœ¨ç›¸æœºè§†é‡å†…
- æ—¥å¿—è¾“å‡ºä¸è¶³ï¼Œéš¾ä»¥è°ƒè¯•

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: ObjectPlacer - ç´¢å¼•è¾¹ç•Œæ£€æŸ¥

#### Start() æ–¹æ³•å¢å¼º
```csharp
void Start()
{
    // éªŒè¯é¢„åˆ¶ä½“æ•°ç»„
    if (placeablePrefabs != null && placeablePrefabs.Length > 0)
    {
        // ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
        if (currentPrefabIndex < 0 || currentPrefabIndex >= placeablePrefabs.Length)
        {
            currentPrefabIndex = 0;
            Debug.LogWarning($"[ObjectPlacer] currentPrefabIndex è¶…å‡ºèŒƒå›´ï¼Œå·²é‡ç½®ä¸º 0");
        }
        // ...
    }
    else
    {
        Debug.LogWarning("[ObjectPlacer] æ²¡æœ‰é…ç½®é¢„åˆ¶ä½“æ•°ç»„ï¼");
    }
}
```

#### CreatePreviewObject() å¢å¼º
```csharp
void CreatePreviewObject()
{
    if (placeablePrefabs == null || placeablePrefabs.Length == 0) return;

    // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
    if (currentPrefabIndex < 0 || currentPrefabIndex >= placeablePrefabs.Length)
    {
        currentPrefabIndex = 0;
    }

    GameObject prefab = placeablePrefabs[currentPrefabIndex];
    if (prefab == null) return;
    // ...
}
```

#### PlaceObject() å¢å¼º
```csharp
public void PlaceObject()
{
    if (placeablePrefabs == null || placeablePrefabs.Length == 0)
    {
        Debug.LogWarning("[ObjectPlacer] æ²¡æœ‰å¯æ”¾ç½®çš„é¢„åˆ¶ä½“ï¼");
        return;
    }

    // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
    if (currentPrefabIndex < 0 || currentPrefabIndex >= placeablePrefabs.Length)
    {
        currentPrefabIndex = 0;
    }
    // ...
}
```

### ä¿®å¤2: StackController - å¢å¼ºæ—¥å¿—å’ŒéªŒè¯

#### Start() æ–¹æ³•å¢å¼º
```csharp
// åˆ›å»ºå †å æ ¹èŠ‚ç‚¹
GameObject rootObj = new GameObject("StackRoot");
rootObj.transform.SetParent(transform);
rootObj.transform.localPosition = Vector3.zero;
stackRoot = rootObj.transform;

Debug.Log($"[StackController] StackRoot åˆ›å»ºäº: {transform.name}");
Debug.Log($"[StackController] StackRoot ä½ç½®: {stackRoot.position}");
```

#### CreateInitialStack() å®Œå…¨é‡å†™
```csharp
void CreateInitialStack()
{
    if (initialStackCount <= 0)
    {
        Debug.LogWarning("[StackController] initialStackCount ä¸º 0ï¼Œä¸ä¼šåˆ›å»ºç‰©ä½“ï¼");
        return;
    }

    Debug.Log($"[StackController] å¼€å§‹åˆ›å»º {initialStackCount} ä¸ªå †å ç‰©ä½“...");
    
    for (int i = 0; i < initialStackCount; i++)
    {
        GameObject obj = AddObjectToStack();
        if (obj != null)
        {
            Debug.Log($"[StackController] åˆ›å»ºç‰©ä½“ {i}: {obj.name} åœ¨ä½ç½® {obj.transform.position}");
        }
        else
        {
            Debug.LogError($"[StackController] åˆ›å»ºç‰©ä½“ {i} å¤±è´¥ï¼");
        }
    }

    Debug.Log($"[StackController] âœ“ å †å åˆ›å»ºå®Œæˆ: {stackedObjects.Count}/{initialStackCount} ä¸ªç‰©ä½“");
    Debug.Log($"[StackController] ç‰©ä½“çˆ¶å¯¹è±¡: {(stackRoot != null ? stackRoot.name : "null")}");
    
    if (stackedObjects.Count != initialStackCount)
    {
        Debug.LogError($"[StackController] è­¦å‘Šï¼šå®é™…åˆ›å»ºæ•°é‡ ({stackedObjects.Count}) ä¸é¢„æœŸ ({initialStackCount}) ä¸ç¬¦ï¼");
    }
}
```

#### AddObjectToStack() å¢å¼º
```csharp
newObject.name = $"StackObject_{stackedObjects.Count}";

// è®¾ç½®ä½ç½®
float yPosition = stackedObjects.Count * objectSpacing;
newObject.transform.localPosition = new Vector3(0, yPosition, 0);

// ç¡®ä¿ç‰©ä½“å¯è§ï¼ˆè®¾ç½®layerï¼‰
newObject.layer = gameObject.layer;

stackedObjects.Add(newObject);

if (logDropEvents)
{
    Debug.Log($"[StackController] âœ“ æ·»åŠ ç‰©ä½“: {newObject.name}, æœ¬åœ°ä½ç½®: {newObject.transform.localPosition}, ä¸–ç•Œä½ç½®: {newObject.transform.position}");
}
```

---

## ğŸ” è°ƒè¯•æŒ‡å—

### 1. æ£€æŸ¥ ObjectPlacer é…ç½®

åœ¨ Inspector ä¸­æ£€æŸ¥ï¼š
```
ObjectPlacer ç»„ä»¶:
â˜ placeablePrefabs æ•°ç»„å·²è®¾ç½®
â˜ æ•°ç»„å¤§å° > 0
â˜ æ•°ç»„ä¸­è‡³å°‘æœ‰ä¸€ä¸ªéç©ºé¢„åˆ¶ä½“
â˜ currentPrefabIndex < placeablePrefabs.Length
```

### 2. æ£€æŸ¥ StackController é…ç½®

åœ¨ Inspector ä¸­æ£€æŸ¥ï¼š
```
StackController ç»„ä»¶:
â˜ initialStackCount > 0 ï¼ˆå»ºè®®ï¼š5ï¼‰
â˜ objectSpacing > 0 ï¼ˆå»ºè®®ï¼š1.0ï¼‰
â˜ objectPrefab å¯ä»¥ä¸º nullï¼ˆä¼šåˆ›å»ºé»˜è®¤ç«‹æ–¹ä½“ï¼‰
â˜ logDropEvents = trueï¼ˆæŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼‰
```

### 3. æŸ¥çœ‹ Console æ—¥å¿—

è¿è¡Œæ¸¸æˆåï¼ŒæŸ¥çœ‹ Console åº”è¯¥çœ‹åˆ°ï¼š
```
[StackController] StackRoot åˆ›å»ºäº: SwaySystem
[StackController] StackRoot ä½ç½®: (0.0, 0.0, 0.0)
[StackController] å¼€å§‹åˆ›å»º 5 ä¸ªå †å ç‰©ä½“...
[StackController] åˆ›å»ºç‰©ä½“ 0: StackObject_0 åœ¨ä½ç½® (0.0, 0.0, 0.0)
[StackController] âœ“ æ·»åŠ ç‰©ä½“: StackObject_0, æœ¬åœ°ä½ç½®: (0.00, 0.00, 0.00), ä¸–ç•Œä½ç½®: (0.00, 0.00, 0.00)
[StackController] åˆ›å»ºç‰©ä½“ 1: StackObject_1 åœ¨ä½ç½® (0.0, 1.0, 0.0)
...
[StackController] âœ“ å †å åˆ›å»ºå®Œæˆ: 5/5 ä¸ªç‰©ä½“
[StackController] ç‰©ä½“çˆ¶å¯¹è±¡: StackRoot
```

### 4. æ£€æŸ¥ Hierarchy

å±•å¼€å±‚çº§ç»“æ„åº”è¯¥çœ‹åˆ°ï¼š
```
SwaySystem
â””â”€â”€ StackRoot
    â”œâ”€â”€ StackObject_0
    â”œâ”€â”€ StackObject_1
    â”œâ”€â”€ StackObject_2
    â”œâ”€â”€ StackObject_3
    â””â”€â”€ StackObject_4
```

### 5. æ£€æŸ¥ Scene è§†å›¾

åœ¨ Scene è§†å›¾ä¸­ï¼š
```
â˜ ç¡®ä¿ç›¸æœºèƒ½çœ‹åˆ°å †å ä½ç½®
â˜ æ£€æŸ¥ç‰©ä½“çš„ä¸–ç•Œåæ ‡
â˜ ç¡®è®¤ç‰©ä½“çš„ Scale ä¸æ˜¯ (0,0,0)
â˜ æ£€æŸ¥ç‰©ä½“çš„ Renderer æ˜¯å¦å¯ç”¨
```

---

## ğŸ¯ å¸¸è§é—®é¢˜è§£å†³

### Q1: çœ‹ä¸åˆ°ç‰©ä½“ä½† Console æ˜¾ç¤ºå·²åˆ›å»º

**å¯èƒ½åŸå› :**
- ç›¸æœºä½ç½®ä¸å¯¹
- ç‰©ä½“åœ¨ç›¸æœºè§†é‡å¤–
- ç‰©ä½“çš„ Scale å¤ªå°

**è§£å†³æ–¹æ³•:**
```csharp
// åœ¨ Scene è§†å›¾ä¸­åŒå‡» StackRoot å®šä½
// æˆ–è°ƒæ•´ç›¸æœºä½ç½®
Camera.main.transform.position = new Vector3(0, 2.5f, -10);
Camera.main.orthographicSize = 5;
```

### Q2: åˆ›å»ºæ•°é‡ä¸å¯¹

**æ£€æŸ¥:**
```csharp
// ç¡®è®¤ initialStackCount è®¾ç½®
Debug.Log($"initialStackCount = {stackController.initialStackCount}");

// ç¡®è®¤å®é™…åˆ›å»ºæ•°é‡
Debug.Log($"å®é™…åˆ›å»º = {stackController.stackedObjects.Count}");
```

### Q3: ObjectPlacer æŠ¥é”™

**æ£€æŸ¥:**
```csharp
// ç¡®ä¿æ•°ç»„å·²é…ç½®
if (placeablePrefabs == null || placeablePrefabs.Length == 0)
{
    Debug.LogError("éœ€è¦é…ç½® placeablePrefabsï¼");
}

// é‡ç½®ç´¢å¼•
currentPrefabIndex = 0;
```

### Q4: ç‰©ä½“åˆ›å»ºåç«‹å³æ¶ˆå¤±

**å¯èƒ½åŸå› :**
- æ‰è½ç³»ç»Ÿç«‹å³è§¦å‘
- å€¾å€’é˜¶æ®µå¯¼è‡´æ‰è½

**æ£€æŸ¥:**
```csharp
// ç¡®è®¤åˆå§‹é˜¶æ®µä¸ºå±…ä¸­
Debug.Log($"å½“å‰é˜¶æ®µ: {swayController.CurrentPhase}");

// åº”è¯¥æ˜¯ Center
```

---

## ğŸ“‹ å®Œæ•´è®¾ç½®æ£€æŸ¥æ¸…å•

### åœºæ™¯è®¾ç½®
- [ ] åˆ›å»ºç©º GameObject å‘½åä¸º "SwaySystem"
- [ ] æ·»åŠ  SwayController ç»„ä»¶
- [ ] æ·»åŠ  StackController ç»„ä»¶
- [ ] æ·»åŠ  StackVisualController ç»„ä»¶

### StackController é…ç½®
- [ ] initialStackCount = 5ï¼ˆæˆ–å…¶ä»– > 0 çš„å€¼ï¼‰
- [ ] objectSpacing = 1.0
- [ ] logDropEvents = true
- [ ] showDebugInfo = true

### ç›¸æœºè®¾ç½®
- [ ] ç¡®ä¿æœ‰ Main Camera
- [ ] ç›¸æœºä½ç½®èƒ½çœ‹åˆ° (0, 0, 0) åˆ° (0, 5, 0) åŒºåŸŸ
- [ ] å¦‚æœæ˜¯ 2Dï¼šCamera.orthographic = true

### è¿è¡Œæµ‹è¯•
- [ ] è¿›å…¥ Play æ¨¡å¼
- [ ] æ£€æŸ¥ Console æ—¥å¿—
- [ ] åœ¨ Hierarchy ä¸­å±•å¼€ SwaySystem > StackRoot
- [ ] ç¡®è®¤ç‰©ä½“æ•°é‡æ­£ç¡®
- [ ] åœ¨ Scene è§†å›¾ä¸­çœ‹åˆ°ç‰©ä½“

---

## ğŸ› ï¸ è°ƒè¯•å·¥å…·ä»£ç 

### ä¸´æ—¶è°ƒè¯•è„šæœ¬

åˆ›å»ºæ­¤è„šæœ¬ç”¨äºè°ƒè¯•ï¼š

```csharp
using UnityEngine;

public class StackDebugger : MonoBehaviour
{
    public StackController stackController;
    
    void Start()
    {
        if (stackController == null)
            stackController = GetComponent<StackController>();
        
        Invoke("DebugStack", 1f);
    }
    
    void DebugStack()
    {
        Debug.Log("=== å †å è°ƒè¯•ä¿¡æ¯ ===");
        Debug.Log($"StackController å­˜åœ¨: {stackController != null}");
        
        if (stackController != null)
        {
            Debug.Log($"initialStackCount: {stackController.initialStackCount}");
            Debug.Log($"å®é™…ç‰©ä½“æ•°é‡: {stackController.stackedObjects.Count}");
            Debug.Log($"StackRoot: {stackController.StackRoot != null}");
            
            if (stackController.StackRoot != null)
            {
                Debug.Log($"StackRoot ä½ç½®: {stackController.StackRoot.position}");
                Debug.Log($"StackRoot å­ç‰©ä½“æ•°é‡: {stackController.StackRoot.childCount}");
                
                for (int i = 0; i < stackController.StackRoot.childCount; i++)
                {
                    Transform child = stackController.StackRoot.GetChild(i);
                    Debug.Log($"  å­ç‰©ä½“ {i}: {child.name} ä½ç½®: {child.position}");
                }
            }
        }
        Debug.Log("==================");
    }
}
```

---

## âœ… éªŒè¯ä¿®å¤

ä¿®å¤ååº”è¯¥ï¼š
1. âœ… æ—  IndexOutOfRangeException é”™è¯¯
2. âœ… Console æ˜¾ç¤ºè¯¦ç»†çš„åˆ›å»ºæ—¥å¿—
3. âœ… Hierarchy ä¸­çœ‹åˆ°æ‰€æœ‰å †å ç‰©ä½“
4. âœ… Scene è§†å›¾ä¸­çœ‹åˆ°ç‰©ä½“
5. âœ… ç‰©ä½“æ•°é‡ä¸ initialStackCount ä¸€è‡´

---

## ğŸ“ æ›´æ–°å†…å®¹

### ObjectPlacer.cs
- âœ… æ·»åŠ ç´¢å¼•è¾¹ç•Œæ£€æŸ¥ï¼ˆ3å¤„ï¼‰
- âœ… æ”¹è¿›é”™è¯¯æç¤º
- âœ… éªŒè¯é¢„åˆ¶ä½“æ•°ç»„

### StackController.cs
- âœ… å¢å¼ºæ—¥å¿—è¾“å‡º
- âœ… æ·»åŠ åˆ›å»ºéªŒè¯
- âœ… è¯¦ç»†çš„ä½ç½®ä¿¡æ¯
- âœ… æ•°é‡ä¸åŒ¹é…è­¦å‘Š

---

**ä¿®å¤ç‰ˆæœ¬**: 1.1.2  
**æµ‹è¯•çŠ¶æ€**: âœ… å·²éªŒè¯  
**å…¼å®¹æ€§**: å®Œå…¨å‘åå…¼å®¹


