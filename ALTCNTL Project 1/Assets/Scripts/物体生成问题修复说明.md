# 物体生成问题修复说明

> **修复日期**: 2025-10-13  
> **版本**: 1.1.2  
> **问题**: IndexOutOfRangeException 和 物体未生成

---

## 🐛 修复的问题

### 问题1: IndexOutOfRangeException

**错误信息:**
```
IndexOutOfRangeException: Index was outside the bounds of the array.
ObjectPlacer.CreatePreviewObject () (at Assets/Scripts/ObjectPlacer.cs:216)
```

**原因:**
- `currentPrefabIndex` 可能超出 `placeablePrefabs` 数组范围
- 没有在访问数组前验证索引

### 问题2: 场景中看不到生成的物体

**现象:**
- 设置了 `initialStackCount` 但看不到物体
- Hierarchy中没有显示创建的物体

**可能原因:**
- 物体在 `StackRoot` 下创建，Hierarchy未展开
- 物体位置不在相机视野内
- 日志输出不足，难以调试

---

## ✅ 修复方案

### 修复1: ObjectPlacer - 索引边界检查

#### Start() 方法增强
```csharp
void Start()
{
    // 验证预制体数组
    if (placeablePrefabs != null && placeablePrefabs.Length > 0)
    {
        // 确保索引有效
        if (currentPrefabIndex < 0 || currentPrefabIndex >= placeablePrefabs.Length)
        {
            currentPrefabIndex = 0;
            Debug.LogWarning($"[ObjectPlacer] currentPrefabIndex 超出范围，已重置为 0");
        }
        // ...
    }
    else
    {
        Debug.LogWarning("[ObjectPlacer] 没有配置预制体数组！");
    }
}
```

#### CreatePreviewObject() 增强
```csharp
void CreatePreviewObject()
{
    if (placeablePrefabs == null || placeablePrefabs.Length == 0) return;

    // 确保索引在有效范围内
    if (currentPrefabIndex < 0 || currentPrefabIndex >= placeablePrefabs.Length)
    {
        currentPrefabIndex = 0;
    }

    GameObject prefab = placeablePrefabs[currentPrefabIndex];
    if (prefab == null) return;
    // ...
}
```

#### PlaceObject() 增强
```csharp
public void PlaceObject()
{
    if (placeablePrefabs == null || placeablePrefabs.Length == 0)
    {
        Debug.LogWarning("[ObjectPlacer] 没有可放置的预制体！");
        return;
    }

    // 确保索引在有效范围内
    if (currentPrefabIndex < 0 || currentPrefabIndex >= placeablePrefabs.Length)
    {
        currentPrefabIndex = 0;
    }
    // ...
}
```

### 修复2: StackController - 增强日志和验证

#### Start() 方法增强
```csharp
// 创建堆叠根节点
GameObject rootObj = new GameObject("StackRoot");
rootObj.transform.SetParent(transform);
rootObj.transform.localPosition = Vector3.zero;
stackRoot = rootObj.transform;

Debug.Log($"[StackController] StackRoot 创建于: {transform.name}");
Debug.Log($"[StackController] StackRoot 位置: {stackRoot.position}");
```

#### CreateInitialStack() 完全重写
```csharp
void CreateInitialStack()
{
    if (initialStackCount <= 0)
    {
        Debug.LogWarning("[StackController] initialStackCount 为 0，不会创建物体！");
        return;
    }

    Debug.Log($"[StackController] 开始创建 {initialStackCount} 个堆叠物体...");
    
    for (int i = 0; i < initialStackCount; i++)
    {
        GameObject obj = AddObjectToStack();
        if (obj != null)
        {
            Debug.Log($"[StackController] 创建物体 {i}: {obj.name} 在位置 {obj.transform.position}");
        }
        else
        {
            Debug.LogError($"[StackController] 创建物体 {i} 失败！");
        }
    }

    Debug.Log($"[StackController] ✓ 堆叠创建完成: {stackedObjects.Count}/{initialStackCount} 个物体");
    Debug.Log($"[StackController] 物体父对象: {(stackRoot != null ? stackRoot.name : "null")}");
    
    if (stackedObjects.Count != initialStackCount)
    {
        Debug.LogError($"[StackController] 警告：实际创建数量 ({stackedObjects.Count}) 与预期 ({initialStackCount}) 不符！");
    }
}
```

#### AddObjectToStack() 增强
```csharp
newObject.name = $"StackObject_{stackedObjects.Count}";

// 设置位置
float yPosition = stackedObjects.Count * objectSpacing;
newObject.transform.localPosition = new Vector3(0, yPosition, 0);

// 确保物体可见（设置layer）
newObject.layer = gameObject.layer;

stackedObjects.Add(newObject);

if (logDropEvents)
{
    Debug.Log($"[StackController] ✓ 添加物体: {newObject.name}, 本地位置: {newObject.transform.localPosition}, 世界位置: {newObject.transform.position}");
}
```

---

## 🔍 调试指南

### 1. 检查 ObjectPlacer 配置

在 Inspector 中检查：
```
ObjectPlacer 组件:
☐ placeablePrefabs 数组已设置
☐ 数组大小 > 0
☐ 数组中至少有一个非空预制体
☐ currentPrefabIndex < placeablePrefabs.Length
```

### 2. 检查 StackController 配置

在 Inspector 中检查：
```
StackController 组件:
☐ initialStackCount > 0 （建议：5）
☐ objectSpacing > 0 （建议：1.0）
☐ objectPrefab 可以为 null（会创建默认立方体）
☐ logDropEvents = true（查看详细日志）
```

### 3. 查看 Console 日志

运行游戏后，查看 Console 应该看到：
```
[StackController] StackRoot 创建于: SwaySystem
[StackController] StackRoot 位置: (0.0, 0.0, 0.0)
[StackController] 开始创建 5 个堆叠物体...
[StackController] 创建物体 0: StackObject_0 在位置 (0.0, 0.0, 0.0)
[StackController] ✓ 添加物体: StackObject_0, 本地位置: (0.00, 0.00, 0.00), 世界位置: (0.00, 0.00, 0.00)
[StackController] 创建物体 1: StackObject_1 在位置 (0.0, 1.0, 0.0)
...
[StackController] ✓ 堆叠创建完成: 5/5 个物体
[StackController] 物体父对象: StackRoot
```

### 4. 检查 Hierarchy

展开层级结构应该看到：
```
SwaySystem
└── StackRoot
    ├── StackObject_0
    ├── StackObject_1
    ├── StackObject_2
    ├── StackObject_3
    └── StackObject_4
```

### 5. 检查 Scene 视图

在 Scene 视图中：
```
☐ 确保相机能看到堆叠位置
☐ 检查物体的世界坐标
☐ 确认物体的 Scale 不是 (0,0,0)
☐ 检查物体的 Renderer 是否启用
```

---

## 🎯 常见问题解决

### Q1: 看不到物体但 Console 显示已创建

**可能原因:**
- 相机位置不对
- 物体在相机视野外
- 物体的 Scale 太小

**解决方法:**
```csharp
// 在 Scene 视图中双击 StackRoot 定位
// 或调整相机位置
Camera.main.transform.position = new Vector3(0, 2.5f, -10);
Camera.main.orthographicSize = 5;
```

### Q2: 创建数量不对

**检查:**
```csharp
// 确认 initialStackCount 设置
Debug.Log($"initialStackCount = {stackController.initialStackCount}");

// 确认实际创建数量
Debug.Log($"实际创建 = {stackController.stackedObjects.Count}");
```

### Q3: ObjectPlacer 报错

**检查:**
```csharp
// 确保数组已配置
if (placeablePrefabs == null || placeablePrefabs.Length == 0)
{
    Debug.LogError("需要配置 placeablePrefabs！");
}

// 重置索引
currentPrefabIndex = 0;
```

### Q4: 物体创建后立即消失

**可能原因:**
- 掉落系统立即触发
- 倾倒阶段导致掉落

**检查:**
```csharp
// 确认初始阶段为居中
Debug.Log($"当前阶段: {swayController.CurrentPhase}");

// 应该是 Center
```

---

## 📋 完整设置检查清单

### 场景设置
- [ ] 创建空 GameObject 命名为 "SwaySystem"
- [ ] 添加 SwayController 组件
- [ ] 添加 StackController 组件
- [ ] 添加 StackVisualController 组件

### StackController 配置
- [ ] initialStackCount = 5（或其他 > 0 的值）
- [ ] objectSpacing = 1.0
- [ ] logDropEvents = true
- [ ] showDebugInfo = true

### 相机设置
- [ ] 确保有 Main Camera
- [ ] 相机位置能看到 (0, 0, 0) 到 (0, 5, 0) 区域
- [ ] 如果是 2D：Camera.orthographic = true

### 运行测试
- [ ] 进入 Play 模式
- [ ] 检查 Console 日志
- [ ] 在 Hierarchy 中展开 SwaySystem > StackRoot
- [ ] 确认物体数量正确
- [ ] 在 Scene 视图中看到物体

---

## 🛠️ 调试工具代码

### 临时调试脚本

创建此脚本用于调试：

```csharp
using UnityEngine;

public class StackDebugger : MonoBehaviour
{
    public StackController stackController;
    
    void Start()
    {
        if (stackController == null)
            stackController = GetComponent<StackController>();
        
        Invoke("DebugStack", 1f);
    }
    
    void DebugStack()
    {
        Debug.Log("=== 堆叠调试信息 ===");
        Debug.Log($"StackController 存在: {stackController != null}");
        
        if (stackController != null)
        {
            Debug.Log($"initialStackCount: {stackController.initialStackCount}");
            Debug.Log($"实际物体数量: {stackController.stackedObjects.Count}");
            Debug.Log($"StackRoot: {stackController.StackRoot != null}");
            
            if (stackController.StackRoot != null)
            {
                Debug.Log($"StackRoot 位置: {stackController.StackRoot.position}");
                Debug.Log($"StackRoot 子物体数量: {stackController.StackRoot.childCount}");
                
                for (int i = 0; i < stackController.StackRoot.childCount; i++)
                {
                    Transform child = stackController.StackRoot.GetChild(i);
                    Debug.Log($"  子物体 {i}: {child.name} 位置: {child.position}");
                }
            }
        }
        Debug.Log("==================");
    }
}
```

---

## ✅ 验证修复

修复后应该：
1. ✅ 无 IndexOutOfRangeException 错误
2. ✅ Console 显示详细的创建日志
3. ✅ Hierarchy 中看到所有堆叠物体
4. ✅ Scene 视图中看到物体
5. ✅ 物体数量与 initialStackCount 一致

---

## 📝 更新内容

### ObjectPlacer.cs
- ✅ 添加索引边界检查（3处）
- ✅ 改进错误提示
- ✅ 验证预制体数组

### StackController.cs
- ✅ 增强日志输出
- ✅ 添加创建验证
- ✅ 详细的位置信息
- ✅ 数量不匹配警告

---

**修复版本**: 1.1.2  
**测试状态**: ✅ 已验证  
**兼容性**: 完全向后兼容


