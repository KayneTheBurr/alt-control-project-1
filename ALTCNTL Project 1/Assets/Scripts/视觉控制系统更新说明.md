# 堆叠视觉控制系统 - 更新说明

> **更新日期**: 2025-10-13  
> **版本**: 1.1  
> **新增功能**: 动态x轴偏移视觉控制

---

## 🎉 更新概述

本次更新为摇摆倾斜系统添加了**堆叠视觉控制器**（StackVisualController），能够根据倾斜阶段、物品数量和位置，智能调整堆叠物体的x轴偏移，实现更加真实的堆叠视觉效果。

---

## ✨ 新增功能

### 1. StackVisualController 组件

**核心特性：**
- ✅ 智能偏移计算 - 基于倾斜阶段自动调整物体位置
- ✅ 高度影响系数 - 越高的物体偏移越大，模拟真实重心偏移
- ✅ 多种偏移模式 - Linear（线性）、Exponential（指数）、Sine（正弦）、Custom（自定义）
- ✅ 平滑动画系统 - 自然的位置过渡
- ✅ 位置跟踪API - 获取最低端及所有物体的x轴位置
- ✅ 实时调试可视化 - Scene和Game视图调试信息

### 2. 视觉效果对比

**无视觉控制：**
```
    ▢
    ▢
    ▢     所有物体垂直对齐
    ▢
    ▢
```

**有视觉控制（右倾2）：**
```
        ▢     ← 顶部（偏移 +0.30）
       ▢      ← 中上（偏移 +0.19）
      ▢       ← 中间（偏移 +0.08）
     ▢        ← 中下（偏移 +0.02）
    ▢         ← 底部（偏移 0）
```

---

## 📦 新增文件

### 核心代码
- **StackVisualController.cs** - 视觉控制器主要代码（~15 KB）

### 文档
- **堆叠视觉控制说明.txt** - 详细使用说明（~18 KB）
- **视觉控制系统更新说明.md** - 本文件

### 更新的文件
- **StackController.cs** - 添加了 StackVisualController 集成
- **SwaySystemQuickSetup.cs** - 添加了自动设置 StackVisualController
- **README_SWAY_SYSTEM.md** - 更新了文档说明
- **文件清单.txt** - 更新了文件列表

---

## 🚀 快速使用

### 方法1：使用快速设置工具（推荐）

如果您已有摇摆系统：
1. 进入Play模式
2. 在 SwaySystemQuickSetup 上勾选 setupSystem
3. StackVisualController 会自动添加并配置

如果是新项目：
1. 创建空GameObject
2. 添加 SwaySystemQuickSetup 组件
3. 勾选 setupSystem
4. 完成！

### 方法2：手动添加

```csharp
// 在已有SwaySystem上添加组件
StackVisualController visual = gameObject.AddComponent<StackVisualController>();

// 配置参数
visual.baseOffsetPerTilt = 0.15f;     // 每级倾斜偏移
visual.heightMultiplier = 1.0f;       // 高度系数
visual.offsetMode = StackVisualController.OffsetMode.Exponential;
visual.smoothTime = 0.2f;             // 平滑时间
visual.useSmoothMovement = true;      // 启用平滑
```

---

## 🎯 核心API

### 获取位置信息

```csharp
StackVisualController visual = GetComponent<StackVisualController>();

// 获取最低端物体的x位置
float baseX = visual.GetBaseObjectXPosition();

// 获取所有物体的x位置数组
float[] allX = visual.GetAllXPositions();

// 遍历所有物体位置
for (int i = 0; i < allX.Length; i++) {
    Debug.Log($"物体 {i}: x = {allX[i]:F3}");
}

// 获取指定物体位置
float topX = visual.GetObjectXPosition(stackController.GetStackHeight() - 1);
```

### 设置和控制

```csharp
// 设置基准x位置
visual.SetBaseXPosition(0.5f);

// 手动刷新位置（添加/移除物体后）
visual.RefreshPositions();

// 获取调试信息
string info = visual.GetOffsetInfo();
Debug.Log(info);
```

---

## 🔧 参数说明

### baseOffsetPerTilt（每级倾斜偏移）
- **默认**: 0.15
- **建议范围**: 0.05 - 0.30
- **效果**: 控制倾斜时的基础偏移量

### heightMultiplier（高度影响系数）
- **默认**: 1.0
- **范围**: 0.0 - 2.0
- **效果**: 控制高度对偏移的影响程度
  - 0.0 = 所有物体偏移相同
  - 1.0 = 正常高度影响
  - 2.0 = 高度影响加倍

### offsetMode（偏移模式）
- **Linear** - 线性偏移，均匀分布
- **Exponential** - 指数偏移，越高越明显（推荐）
- **Sine** - 正弦曲线，自然平滑
- **Custom** - 使用自定义 AnimationCurve

### smoothTime（平滑时间）
- **默认**: 0.2秒
- **范围**: 0.0 - 1.0
- **效果**: 位置变化的平滑程度

---

## 📐 偏移计算公式

```
最终偏移 = baseOffsetPerTilt × 倾斜级别 × 高度系数 × heightMultiplier × 方向

其中：
• 倾斜级别: 0-3（居中=0，倾1=1，倾2=2，倾倒=3）
• 方向: -1（左）或 1（右）
• 高度系数: 根据 offsetMode 计算（0-1）
  - Linear: height
  - Exponential: height²
  - Sine: sin(height × π/2)
  - Custom: customCurve.Evaluate(height)
```

### 示例计算（右倾2，5个物体）

使用 Exponential 模式：

| 物体 | 归一化高度 | 高度系数 | 偏移计算 | 最终偏移 |
|------|-----------|---------|---------|---------|
| 0（底部）| 0/4 = 0 | 0² = 0 | 0.15×2×0×1×1 | 0 |
| 1 | 1/4 = 0.25 | 0.25² = 0.0625 | 0.15×2×0.0625×1×1 | +0.019 |
| 2（中间）| 2/4 = 0.5 | 0.5² = 0.25 | 0.15×2×0.25×1×1 | +0.075 |
| 3 | 3/4 = 0.75 | 0.75² = 0.5625 | 0.15×2×0.5625×1×1 | +0.169 |
| 4（顶部）| 4/4 = 1 | 1² = 1 | 0.15×2×1×1×1 | +0.300 |

---

## 🎨 视觉效果预设

### 真实物理效果
```csharp
visual.baseOffsetPerTilt = 0.08f;
visual.heightMultiplier = 1.0f;
visual.offsetMode = OffsetMode.Exponential;
```

### 卡通夸张效果
```csharp
visual.baseOffsetPerTilt = 0.25f;
visual.heightMultiplier = 1.5f;
visual.offsetMode = OffsetMode.Exponential;
```

### 极简均匀效果
```csharp
visual.baseOffsetPerTilt = 0.15f;
visual.heightMultiplier = 0.5f;
visual.offsetMode = OffsetMode.Linear;
```

### 自然摇摆效果
```csharp
visual.baseOffsetPerTilt = 0.12f;
visual.heightMultiplier = 1.0f;
visual.offsetMode = OffsetMode.Sine;
```

---

## 🐛 调试功能

### Game视图调试信息
左下角显示：
- 物体数量
- 当前倾斜阶段
- 基准X位置
- 偏移模式
- 每个物体的x位置和偏移量

启用方式：
```csharp
visual.showDebugInfo = true;
visual.logOffsetCalculations = true;  // 详细日志
```

### Scene视图可视化
- 🟡 黄色线 - 物体间连线
- 🟢 绿色线 - 基准垂直线
- 🔴 红色线 - 偏移指示线

---

## 🔗 系统集成

### 与计分系统配合
```csharp
// 根据偏移量计算难度系数
float[] xPos = visual.GetAllXPositions();
float maxOffset = Mathf.Abs(xPos[xPos.Length - 1] - xPos[0]);
float difficultyMultiplier = 1.0f + maxOffset;
score = baseScore * difficultyMultiplier;
```

### 与特效系统配合
```csharp
// 顶部物体偏移过大时触发警告
float topX = visual.GetObjectXPosition(stackHeight - 1);
float baseX = visual.GetBaseObjectXPosition();
if (Mathf.Abs(topX - baseX) > 0.5f) {
    PlayWarningParticles();
    CameraShake();
}
```

### 与音效系统配合
```csharp
void OnPhaseChanged(SwayPhase old, SwayPhase newPhase) {
    float[] positions = visual.GetAllXPositions();
    float totalOffset = positions[positions.Length - 1] - positions[0];
    
    // 偏移越大，音调越高
    float pitch = 1.0f + Mathf.Abs(totalOffset);
    audioSource.pitch = pitch;
    audioSource.Play();
}
```

---

## ⚡ 性能考虑

### 性能指标
- ✅ 每帧更新：轻量级 SmoothDamp 计算
- ✅ 内存占用：字典缓存，低开销
- ✅ 建议堆叠数量：< 20个物体
- ✅ 适用平台：所有平台（PC/Mobile/WebGL）

### 优化建议
```csharp
// 物体静止时暂停更新
if (swayController.CurrentPhase == SwayPhase.Center && 
    swayController.CurrentCountdown > 3f) {
    visual.enabled = false;  // 暂停
} else {
    visual.enabled = true;   // 恢复
}
```

---

## ❓ 常见问题

**Q: 如何禁用视觉偏移？**
```csharp
// 方法1: 设置偏移为0
visual.baseOffsetPerTilt = 0f;

// 方法2: 禁用组件
visual.enabled = false;

// 方法3: 移除组件
Destroy(visual);
```

**Q: 物体位置不更新？**
```csharp
// 检查引用
if (visual.stackController == null) {
    visual.stackController = GetComponent<StackController>();
}
if (visual.swayController == null) {
    visual.swayController = GetComponent<SwayController>();
}
```

**Q: 如何实现自定义偏移曲线？**
```csharp
visual.offsetMode = OffsetMode.Custom;
// 在Inspector中编辑 customOffsetCurve
// X轴: 0-1（底部到顶部）
// Y轴: 偏移系数
```

**Q: 添加物体后位置不对？**
```csharp
// 添加物体后调用
stackController.AddObjectToStack();
visual.RefreshPositions();  // 刷新位置
```

---

## 📚 相关文档

- **堆叠视觉控制说明.txt** - 详细参数和API说明
- **README_SWAY_SYSTEM.md** - 完整系统文档
- **摇摆系统使用指南.txt** - 核心系统使用指南
- **文件清单.txt** - 所有文件速查表

---

## 🎯 使用建议

1. **从预设开始** - 使用推荐的参数值
2. **观察效果** - 运行游戏并观察视觉变化
3. **调整参数** - 根据游戏风格微调
4. **测试模式** - 尝试不同的 offsetMode
5. **玩家反馈** - 根据玩家体验优化

---

## 🔄 向后兼容

本次更新**完全向后兼容**：
- ✅ 现有代码无需修改
- ✅ 可选功能，不影响核心系统
- ✅ 不添加视觉控制器，系统照常工作
- ✅ 所有旧版API继续有效

---

## 🚀 未来计划

可能的增强功能：
- [ ] 物体间距动态调整
- [ ] Z轴深度偏移（3D效果）
- [ ] 物体倾斜角度独立控制
- [ ] 更多偏移模式（弹性、反弹等）
- [ ] 偏移动画事件系统

---

## 📝 更新日志

### v1.1 (2025-10-13)
- ✨ 新增 StackVisualController 组件
- ✨ 实现智能x轴偏移计算
- ✨ 支持4种偏移模式
- ✨ 添加位置跟踪API
- ✨ 实现平滑动画系统
- 📝 完善文档和使用指南
- 🔧 更新快速设置工具

### v1.0 (2025-10-13)
- 初始版本发布
- 核心摇摆倾斜系统

---

**感谢使用堆叠视觉控制系统！**  
如有问题或建议，请查阅文档或联系支持。

---

**系统版本**: 1.1  
**Unity兼容**: 2019.4+  
**创建日期**: 2025-10-13  
**更新日期**: 2025-10-13


