# 长按输入系统说明

## 📅 更新日期
2024-10-15

---

## 🎮 新增功能概述

### 1. 长按重复触发
玩家按住按键1秒后，会自动再次触发该按键的效果。

### 2. 倾倒阶段反向跨越
在倾倒阶段时，按相反方向的倾倒键会让物体跨越4个阶段。

---

## 🎯 按键配置

| 按键 | 功能 | 详细说明 |
|------|------|----------|
| **小键盘1** | 左倾倒 | 立即进入左倾倒阶段 / 从右倾倒跨越到左倾1 |
| **小键盘2** | 左倾斜 | 向左倾斜一个阶段 |
| **小键盘3** | 右倾斜 | 向右倾斜一个阶段 |
| **小键盘4** | 右倾倒 | 立即进入右倾倒阶段 / 从左倾倒跨越到右倾1 |

---

## 🔄 长按机制

### 工作原理

```
按下按键
    ↓
立即触发一次
    ↓
持续按住
    ↓
计时 1.0 秒
    ↓
再次触发
    ↓
松开重置
```

### 配置参数

```csharp
[Header("长按设置")]
public float holdDuration = 1.0f;        // 长按触发时间
public bool enableHoldRepeat = true;     // 是否启用长按
```

### 使用场景

**场景1：快速连续倾斜**
- 按住小键盘2（左倾斜）
- 立即触发：居中 → 左倾1
- 1秒后：左倾1 → 左倾2

**场景2：紧急调整**
- 按住小键盘3（右倾斜）
- 立即触发：左倾2 → 左倾1
- 1秒后：左倾1 → 居中

---

## ⚡ 倾倒阶段反向跨越

### 阶段结构

```
左倾倒(-3) ← 左倾2(-2) ← 左倾1(-1) ← 居中(0) → 右倾1(1) → 右倾2(2) → 右倾倒(3)
```

### 跨越逻辑

#### 情况1：从左倾倒跨越到右边
```
当前阶段：左倾倒 (-3)
按下：小键盘4（右倾倒）
结果：跨越4个阶段
  左倾倒(-3) → 左倾2(-2) → 左倾1(-1) → 居中(0) → 右倾1(1)
最终：右倾1 (1)
```

#### 情况2：从右倾倒跨越到左边
```
当前阶段：右倾倒 (3)
按下：小键盘1（左倾倒）
结果：跨越4个阶段
  右倾倒(3) → 右倾2(2) → 右倾1(1) → 居中(0) → 左倾1(-1)
最终：左倾1 (-1)
```

### 设计意图

这个机制允许玩家在极端倾倒状态下，通过按相反方向的倾倒键来快速"拉回"物体，而不是完全倒向另一边。这增加了游戏的策略性和紧张感。

---

## 🎭 完整行为表

### 在居中阶段 (0)

| 按键 | 行为 | 结果阶段 |
|------|------|----------|
| 小键盘1 | 立即左倾倒 | 左倾倒 (-3) |
| 小键盘2 | 向左倾斜 | 左倾1 (-1) |
| 小键盘3 | 向右倾斜 | 右倾1 (1) |
| 小键盘4 | 立即右倾倒 | 右倾倒 (3) |

### 在左倾1阶段 (-1)

| 按键 | 行为 | 结果阶段 |
|------|------|----------|
| 小键盘1 | 立即左倾倒 | 左倾倒 (-3) |
| 小键盘2 | 向左倾斜 | 左倾2 (-2) |
| 小键盘3 | 向右倾斜 | 居中 (0) |
| 小键盘4 | 立即右倾倒 | 右倾倒 (3) |

### 在左倾倒阶段 (-3)

| 按键 | 行为 | 结果阶段 |
|------|------|----------|
| 小键盘1 | （无效果，已在左倾倒） | 左倾倒 (-3) |
| 小键盘2 | 向左倾斜（回退） | 左倾2 (-2) |
| 小键盘3 | 向右倾斜（回退） | 左倾2 (-2) |
| 小键盘4 | **跨越4个阶段** | **右倾1 (1)** |

### 在右倾倒阶段 (3)

| 按键 | 行为 | 结果阶段 |
|------|------|----------|
| 小键盘1 | **跨越4个阶段** | **左倾1 (-1)** |
| 小键盘2 | 向左倾斜（回退） | 右倾2 (2) |
| 小键盘3 | 向右倾斜（回退） | 右倾2 (2) |
| 小键盘4 | （无效果，已在右倾倒） | 右倾倒 (3) |

---

## 🔧 代码实现

### 长按检测

```csharp
void HandleKeyInput(KeyCode key, ref float holdTime, ref bool holdTriggered, System.Action action)
{
    // 按下瞬间触发
    if (Input.GetKeyDown(key))
    {
        holdTime = 0f;
        holdTriggered = false;
        action?.Invoke();
    }
    // 按住检测
    else if (Input.GetKey(key) && enableHoldRepeat)
    {
        holdTime += Time.deltaTime;
        
        // 长按触发
        if (holdTime >= holdDuration && !holdTriggered)
        {
            holdTriggered = true;
            action?.Invoke();
        }
    }
    // 松开重置
    else if (Input.GetKeyUp(key))
    {
        holdTime = 0f;
        holdTriggered = false;
    }
}
```

### 倾倒跨越

```csharp
void HandleLeftToppleInput()
{
    // 如果在右倾倒阶段，跨越4个阶段
    if (currentPhase == SwayPhase.RightTopple)
    {
        JumpPhases(-4); // 向左跨越4个阶段
    }
    // 否则立即进入左倾倒
    else
    {
        InstantTopple(SwayPhase.LeftTopple);
    }
}

void JumpPhases(int steps)
{
    int targetValue = (int)currentPhase + steps;
    targetValue = Mathf.Clamp(targetValue, -3, 3);
    SwayPhase targetPhase = (SwayPhase)targetValue;
    ChangePhase(targetPhase);
}
```

---

## 🎓 使用技巧

### 技巧1：连续调整
按住小键盘2或3可以连续倾斜，每次间隔1秒。

### 技巧2：紧急救援
在倾倒阶段时，快速按相反方向的倾倒键可以立即跨越到一个相对安全的位置（倾1阶段）。

### 技巧3：禁用长按
如果不想要长按功能，可以在Inspector中取消勾选 `Enable Hold Repeat`。

### 技巧4：调整长按时间
在Inspector中修改 `Hold Duration` 可以改变长按触发的时间（默认1秒）。

---

## 🐛 调试信息

启用 `Show Debug Info` 和 `Log Phase Changes` 后，Console会显示：

```
[SwayController] 长按触发: Keypad2
[SwayController] 跨越阶段: 左倾倒 → 右倾1 (跨越 4 个阶段)
[SwayController] 阶段转换: 左倾倒 → 右倾1 (用时: 1.00秒)
```

---

## 📝 注意事项

1. **长按仅触发一次**：每次按住只会在1秒时触发一次，不会连续触发
2. **过渡期间无法操作**：在阶段转换动画期间，所有输入都会被忽略
3. **跨越有边界**：跨越4个阶段时会自动限制在有效范围内（-3到3）
4. **同方向倾倒无效**：在左倾倒时按小键盘1，或在右倾倒时按小键盘4，不会有任何效果

---

## 🎯 游戏平衡建议

### 长按时间调整
- **简单难度**：0.8秒（更快速的连续操作）
- **普通难度**：1.0秒（默认）
- **困难难度**：1.5秒（需要更精确的操作）

### 跨越距离调整
如果觉得跨越4个阶段太多或太少，可以修改代码中的数值：

```csharp
// 在 HandleLeftToppleInput 和 HandleRightToppleInput 中
JumpPhases(-4); // 改为 -3 或 -5
JumpPhases(4);  // 改为 3 或 5
```

---

## ✅ 测试清单

- [ ] 测试小键盘1-4的按下触发
- [ ] 测试每个键的长按触发（1秒）
- [ ] 测试在左倾倒时按小键盘4的跨越
- [ ] 测试在右倾倒时按小键盘1的跨越
- [ ] 测试在其他阶段按倾倒键的正常行为
- [ ] 测试禁用长按功能
- [ ] 测试调整长按时间参数

---

## 🔗 相关文件

- `SwayController.cs` - 核心控制器
- `SwayPhase.cs` - 阶段枚举和扩展
- `README_SWAY_SYSTEM.md` - 系统总览

---

**享受新的输入系统！** 🎮

