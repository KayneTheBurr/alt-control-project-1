# 玩家输入系统更新说明

## 📋 更新信息

**日期**: 2024-10-13  
**版本**: v1.4.0  
**类型**: 输入系统重构

---

## 🎮 新的输入方案

### 按键映射

| 按键 | 功能 | 说明 |
|------|------|------|
| **1** | 立即左倾倒 | 直接进入左倾倒阶段 + 立即掉落1个物品 |
| **2** | 向左倾斜 | 向左倾斜一个阶段（逐级） |
| **3** | 向右倾斜 | 向右倾斜一个阶段（逐级） |
| **4** | 立即右倾倒 | 直接进入右倾倒阶段 + 立即掉落1个物品 |

---

## 🔄 输入行为详解

### 2键：向左倾斜一个阶段

**逐级倾斜**，每按一次向左移动一个阶段：

```
居中 → 左倾1 → 左倾2 → 左倾倒
```

**特性**：
- ✅ 平滑过渡（1秒过渡时间）
- ✅ 有旋转动画
- ✅ 会触发倾斜倒计时（5秒）
- ✅ 到达倾倒阶段后自动开始掉落循环

### 3键：向右倾斜一个阶段

**逐级倾斜**，每按一次向右移动一个阶段：

```
居中 → 右倾1 → 右倾2 → 右倾倒
```

**特性**：
- ✅ 平滑过渡（1秒过渡时间）
- ✅ 有旋转动画
- ✅ 会触发倾斜倒计时（5秒）
- ✅ 到达倾倒阶段后自动开始掉落循环

### 1键：立即左倾倒

**直接跳转**到左倾倒阶段，无论当前是什么阶段：

```
任意阶段 →→→ 左倾倒（立即）
```

**特性**：
- ⚡ 立即切换（仍有1秒过渡动画）
- ⚡ **立即掉落1个物品**
- ⚡ 进入倾倒阶段的掉落循环
- ⚡ 适合紧急情况使用

### 4键：立即右倾倒

**直接跳转**到右倾倒阶段，无论当前是什么阶段：

```
任意阶段 →→→ 右倾倒（立即）
```

**特性**：
- ⚡ 立即切换（仍有1秒过渡动画）
- ⚡ **立即掉落1个物品**
- ⚡ 进入倾倒阶段的掉落循环
- ⚡ 适合紧急情况使用

---

## 📊 输入对比

### 旧版输入（已移除）

| 按键 | 功能 |
|------|------|
| ← | 向左倾斜 |
| → | 向右倾斜 |
| ↓ | 回中心 |
| ↑ | 稳定（重置倒计时）|

### 新版输入（当前）

| 按键 | 功能 |
|------|------|
| **1** | 立即左倾倒 + 掉落 |
| **2** | 向左倾斜 |
| **3** | 向右倾斜 |
| **4** | 立即右倾倒 + 掉落 |

---

## 🎯 使用场景

### 场景1：正常游戏

使用 **2** 和 **3** 键逐级控制倾斜：

```
玩家策略：
1. 观察堆叠状态
2. 按 2 向左调整
3. 按 3 向右调整
4. 保持平衡
```

### 场景2：紧急处理

使用 **1** 或 **4** 键快速丢弃物品：

```
紧急情况：
1. 堆叠物品过多
2. 按 1 或 4 立即倾倒
3. 快速丢失顶部物品
4. 恢复控制
```

### 场景3：战略丢弃

主动使用倾倒功能调整堆叠：

```
战略玩法：
1. 堆叠过高，不易控制
2. 主动按 1 或 4 倾倒
3. 减少堆叠高度
4. 重新积累
```

---

## 🔧 技术实现

### 新增方法：InstantTopple

```csharp
/// <summary>
/// 立即切换到倾倒阶段并触发一次掉落
/// </summary>
public void InstantTopple(SwayPhase topplePhase)
{
    if (!topplePhase.IsTopplePhase())
    {
        Debug.LogWarning("只能用于倾倒阶段");
        return;
    }

    // 切换到倾倒阶段
    ChangePhase(topplePhase);

    // 立即触发一次掉落
    OnToppleDrop?.Invoke();
}
```

**工作流程**：

1. **验证**：检查是否为倾倒阶段
2. **切换阶段**：调用 `ChangePhase()`
   - 停止所有现有协程
   - 开始旋转过渡动画
   - 启动倾倒掉落循环
3. **立即掉落**：触发 `OnToppleDrop` 事件
   - StackController 接收事件
   - 移除顶部物品
   - 播放掉落动画

### 修改的方法：HandlePlayerInput

```csharp
void HandlePlayerInput()
{
    if (isTransitioning) return;

    // 1键：立即左倾倒并掉落
    if (Input.GetKeyDown(instantLeftToppleKey))
    {
        InstantTopple(SwayPhase.LeftTopple);
    }
    // 2键：向左倾斜一个阶段
    else if (Input.GetKeyDown(tiltLeftKey))
    {
        TryMovePhase(-1);
    }
    // 3键：向右倾斜一个阶段
    else if (Input.GetKeyDown(tiltRightKey))
    {
        TryMovePhase(1);
    }
    // 4键：立即右倾倒并掉落
    else if (Input.GetKeyDown(instantRightToppleKey))
    {
        InstantTopple(SwayPhase.RightTopple);
    }
}
```

---

## 🎨 配置选项

在 Inspector 中可以自定义按键：

```
SwayController 组件
└─ 玩家输入
    ├─ Instant Left Topple Key = Alpha1  (默认: 1)
    ├─ Tilt Left Key = Alpha2            (默认: 2)
    ├─ Tilt Right Key = Alpha3           (默认: 3)
    └─ Instant Right Topple Key = Alpha4 (默认: 4)
```

**可选的按键代码**：
- `Alpha1` - `Alpha9`: 数字键 1-9
- `Keypad1` - `Keypad9`: 小键盘 1-9
- `Q`, `W`, `E`, `R`: 字母键
- 任何 Unity 支持的 KeyCode

---

## 📈 游戏性影响

### 1. 增加策略深度

玩家现在有更多选择：
- **保守玩法**：只用 2/3 键逐级调整
- **激进玩法**：频繁使用 1/4 键快速丢弃
- **混合策略**：根据情况灵活切换

### 2. 提升紧张感

立即倾倒功能：
- 增加紧急情况的处理选项
- 让玩家在危机时刻有反应空间
- 但也可能加速失败（误操作）

### 3. 技能天花板提升

高级玩家可以：
- 精确控制何时丢弃物品
- 利用倾倒重置堆叠高度
- 开发新的游戏策略

---

## 🎯 平衡性考虑

### 优势

- ✅ 更多控制选项
- ✅ 应对紧急情况的能力
- ✅ 战略丢弃的可能性

### 劣势

- ⚠️ 可能降低游戏难度（如果滥用）
- ⚠️ 需要玩家学习新的按键
- ⚠️ 误操作风险（按错键）

### 建议调整

如果觉得立即倾倒太强：

1. **增加冷却时间**
   ```csharp
   private float instantToppleCooldown = 3f; // 3秒冷却
   private float lastToppleTime = 0f;
   
   public void InstantTopple(SwayPhase topplePhase)
   {
       if (Time.time - lastToppleTime < instantToppleCooldown)
       {
           Debug.Log("冷却中...");
           return;
       }
       
       lastToppleTime = Time.time;
       // ... 原有逻辑
   }
   ```

2. **限制使用次数**
   ```csharp
   public int maxInstantTopples = 3; // 每局最多3次
   private int instantToppleCount = 0;
   
   public void InstantTopple(SwayPhase topplePhase)
   {
       if (instantToppleCount >= maxInstantTopples)
       {
           Debug.Log("已达到使用上限！");
           return;
       }
       
       instantToppleCount++;
       // ... 原有逻辑
   }
   ```

3. **增加惩罚**
   ```csharp
   // 立即倾倒时掉落更多物品
   public void InstantTopple(SwayPhase topplePhase)
   {
       ChangePhase(topplePhase);
       
       // 立即掉落2个物品而不是1个
       OnToppleDrop?.Invoke();
       OnToppleDrop?.Invoke();
   }
   ```

---

## 🧪 测试建议

### 基础功能测试

```
1. 启动游戏
2. 按 2 键 → 观察向左倾斜
3. 按 3 键 → 观察向右倾斜
4. 按 1 键 → 确认立即左倾倒 + 掉落
5. 按 4 键 → 确认立即右倾倒 + 掉落
```

### 边界情况测试

```
1. 已经在左倾倒，按 1 键 → 应该立即掉落
2. 已经在右倾倒，按 4 键 → 应该立即掉落
3. 转换动画中，按任何键 → 应该忽略
4. 堆叠为空，按 1/4 → 不应报错
```

### 游戏性测试

```
1. 玩一局只用 2/3 键
2. 玩一局频繁用 1/4 键
3. 对比游戏体验差异
4. 调整难度平衡
```

---

## 📚 代码示例

### 示例1：在代码中触发倾倒

```csharp
SwayController sway = GetComponent<SwayController>();

// 立即左倾倒
sway.InstantTopple(SwayPhase.LeftTopple);

// 立即右倾倒
sway.InstantTopple(SwayPhase.RightTopple);
```

### 示例2：监听倾倒事件

```csharp
void Start()
{
    SwayController sway = GetComponent<SwayController>();
    
    sway.OnToppleDrop += () => {
        Debug.Log("物品掉落了！");
        // 播放音效
        // 显示特效
        // 更新分数
    };
}
```

### 示例3：自定义输入系统

```csharp
public class CustomInputController : MonoBehaviour
{
    public SwayController swayController;
    
    void Update()
    {
        // 使用游戏手柄
        if (Input.GetButtonDown("GamepadX"))
        {
            swayController.TryMovePhase(-1);
        }
        
        if (Input.GetButtonDown("GamepadB"))
        {
            swayController.TryMovePhase(1);
        }
        
        // 触摸屏输入
        if (Input.touchCount > 0)
        {
            Touch touch = Input.GetTouch(0);
            if (touch.phase == TouchPhase.Began)
            {
                if (touch.position.x < Screen.width / 2)
                {
                    swayController.InstantTopple(SwayPhase.LeftTopple);
                }
                else
                {
                    swayController.InstantTopple(SwayPhase.RightTopple);
                }
            }
        }
    }
}
```

---

## 🔗 相关文件

**修改的文件**：
- `SwayController.cs`

**相关系统**：
- `StackController.cs` - 处理掉落事件
- `SwayPhase.cs` - 阶段定义
- `SwayPhaseSlider.cs` - UI显示

---

## 📝 版本历史

**v1.4.0** (2024-10-13)
- ✅ 重构输入系统
- ✅ 添加立即倾倒功能
- ✅ 移除旧的方向键输入
- ✅ 添加 InstantTopple 方法

**v1.3.1** (2024-10-13)
- UI Slider 方向反向

**v1.3.0** (2024-10-13)
- UI Slider 功能添加

---

## ✅ 总结

新的输入系统提供了：

1. **更简洁的控制**
   - 4个按键对应4种基本操作
   - 易于记忆和使用

2. **更多战术选择**
   - 逐级倾斜 (2/3)
   - 立即倾倒 (1/4)
   - 战略丢弃的可能性

3. **更高的技能天花板**
   - 精确控制
   - 时机把握
   - 策略深度

现在可以运行游戏，体验新的输入系统！🎮

---

**更新日期**: 2024-10-13  
**版本**: v1.4.0  
**类型**: 输入系统重构

